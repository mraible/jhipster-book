= Building an app with JHipster

When I started writing this book, I had a few different ideas for a sample application. My first idea involved creating
a photo gallery to showcase the 1996 VW Bus I've been working on for over 10 years. The project was recently finished and
I wanted a website to show how things have progressed through the years.

I also thought about creating a blog application.
As part of http://raibledesigns.com/rd/entry/getting_hip_with_jhipster_at[my first presentation on JHipster]
(at http://www.denverjug.org/[Denver's Java User Group]), I created a blog application that I live-coded in front of
the audience. After that presentation, I spent several hours polishing the application and started
http://www.jhipster-book.com[The JHipster Mini-Book site] with it.

After thinking about the VW Bus Gallery and developing the blog application, I thought to myself, is this hip enough?
Shouldn't a book about becoming what the JHipster homepage calls a "`Java Hipster`" show how to build a hip application?

I wrote to Julien Dubois, founder of JHipster, and Dennis Sharpe, the technical editor for this book, and asked them
what they thought. We went back and forth on a few ideas: a https://gitter.im[Gitter] clone, a job board for JHipster coders, a shopping-cart
app. Then it hit me: there was an idea I'd been wanting to develop for a while.

It's basically an app that you can use to monitor your health. In late September through mid-October 2014, I'd done a
sugar detox during which I stopped eating sugar, started exercising regularly, and stopped drinking alcohol. I'd had high blood
pressure for over 10 years and was on blood-pressure medication at the time. During the first week of the detox, I ran
out of blood-pressure medication. Since a new prescription required a doctor visit, I decided I'd wait until
after the detox to get it. After three weeks, not only did I lose 15 pounds, but my blood pressure was at normal levels!

Before I started the detox, I came up with a 21-point system to see how healthy I was being each week. Its rules were
simple: you can earn up to three points per day for the following reasons:

1. If you eat healthy, you get a point. Otherwise, zero.
2. If you exercise, you get a point.
3. If you don't drink alcohol, you get a point.

I was surprised to find I got eight points the first week I used this system. During the detox, I got 16 points the
first week, 20 the second, and 21 the third. Before the detox, I thought eating healthy meant eating anything except
fast food. After the detox, I realized that eating healthy for me meant eating no sugar. I'm also a big lover of craft
beer, so I modified the alcohol rule to allow two healthier alcohol drinks (like a greyhound or
red wine) per day.

My goal is to earn 15 points per week. I find that if I get more, I'll likely lose weight and have good blood pressure. If I
get fewer than 15, I risk getting sick. I've been tracking my health like this since September 2014. I've lost 30 pounds and
my blood pressure has returned to and maintained normal levels. I haven't had good blood pressure since my early 20s, so this has been
a life changer for me.

I thought writing a "`21-Point Health`" application would work because tracking your health is always
important. Wearables that can track your health stats might be able to use the APIs or hooks I create to record
points for a day. Imagine hooking into http://dailymile.com[dailymile] (where I track my exercise) or https://untappd.com[Untappd] (where I sometimes list
the beers I drink). Or even displaying other activities for a day (e.g. showing your blood-pressure score that you keep on
http://www.apple.com/ios/health/[iOS Health]).

I thought my idea would fit nicely with JHipster and Spring Boot from a monitoring standpoint. Spring Boot has lots of health
monitors for apps, and now you can use this JHipster app to monitor your health!

== Creating the application

I started using the http://jhipster.github.io/installation/[Installing JHipster] instructions. I'm a Java developer,
so I already had Java 8 installed, as well as Maven and Git. I installed Node.js from https://nodejs.org/[nodejs.org], then
ran the following commands to install http://yeoman.io/[Yeoman] and https://bower.io/[Bower].

[source]
----
npm install -g yo
npm install -g bower
----

I also installed Gulp and JHipster.

[source]
----
npm install -g gulp
npm install -g generator-jhipster
----

TIP: If you need to install Java, Maven or Git, please see http://jhipster.github.io/installation/[JHipster's local installation documentation].

Then I proceeded to build my application. Unlike many application generators in Javaland, Yeoman expects you to be
in the directory you want to create your project in, rather than creating the directory for you. So I created a `21-points`
directory and typed the following command to invoke JHipster.

[source]
----
yo jhipster
----

After running this command, I was prompted to answer questions about how I wanted my application to be generated. You can
see the choices I made in the following screenshot.

[[img-generating-21points]]
.Generating the application
image::chapter2/generating-21points.png[Generating the application, 1082, scaledwidth=100%]

You can see that I chose H2 with disk-based persistence for development and PostgreSQL for my production database. I did
this because using a non-embedded database offers some important benefits:

* Your data is retained when restarting the application.
* Your application starts a bit faster.
* You can use Liquibase to generate a database changelog.

The http://www.liquibase.org/[Liquibase] homepage describes it as source control for your database. It will help create new fields as
you add them to your entities. It will also refactor your database, for example creating tables and dropping columns.
It also has the ability to undo changes to your database, either automatically or with custom SQL.

After answering all the questions, JHipster created a whole bunch of files, then ran `npm install` followed by `bower install`.
To prove everything was good to go, I ran the Java unit tests using `./gradlew test`.

[source]
----
BUILD SUCCESSFUL

Total time: 36.91 secs
----

Next, I started the app using `./gradlew` and then ran the UI integration tests with `gulp itest`. All tests passed with flying colors.

----
$ gulp itest
[12:31:23] Using gulpfile ~/dev/21-points/gulpfile.js
[12:31:23] Starting 'protractor'...
[12:31:24] W/configParser - pattern ./e2e/entities/*.js did not match any files.
[12:31:24] I/direct - Using FirefoxDriver directly...
[12:31:24] I/launcher - Running 1 instances of WebDriver
Started
..........


10 specs, 0 failures
Finished in 29.433 seconds
[12:31:56] I/launcher - 0 instance(s) of WebDriver still running
[12:31:56] I/launcher - firefox #01 passed
[12:31:56] Finished 'protractor' after 33 s
[12:31:56] Starting 'itest'...
[12:31:56] Finished 'itest' after 15 μs
----

To prove the `prod` profile worked and I could talk to PostgreSQL, I installed http://postgresapp.com/[Postgres.app] and tried
creating a local PostgreSQL database with settings from `src/main/resources/config/application-prod.yml`. You can see that
PostgreSQL didn't like that my database name started with a number.

----
'/Applications/Postgres.app/Contents/Versions/9.5/bin'/psql -p5432
[mraible:~] $ '/Applications/Postgres.app/Contents/Versions/9.5/bin'/psql -p5432
psql (9.5.3)
Type "help" for help.

mraible=# create user 21points with password '21points';
ERROR:  syntax error at or near "21"
LINE 1: create user 21points with password '';
                    ^
mraible=# create user health with password 'health';
CREATE ROLE
mraible=# create database health;
CREATE DATABASE
mraible=# grant all privileges on database health to health;
GRANT
mraible=#
----

I chose the name "`health`" instead and updated `application-prod.yml` to use this name and the
specified credentials.

[source,diff]
.src/main/resources/config/application-prod.yml
----
     datasource:
-         url: jdbc:postgresql://localhost:5432/21points
-         name:
-         username: 21points
-         password:
+         url: jdbc:postgresql://localhost:5432/health
+         name:
+         username: health
+         password: health
----

I confirmed I could talk to a PostgreSQL database when running with the `prod` profile.

----
$ ./gradlew -Pprod
...
----------------------------------------------------------
        Application '21points' is running! Access URLs:
        Local:          http://127.0.0.1:8080
        External:       http://172.20.10.2:8080
----------------------------------------------------------
----

=== Adding source control

One of the first things I like to do when creating a new project is to add it to a version-control system (VCS). In this
particular case, I chose Git and https://bitbucket.org[Bitbucket]. Because I don't like my Bower dependencies stored with my source code, I
excluded them by adding the following to `.gitignore`.

----
/src/main/webapp/bower_components/**
----

The following commands show how I initialized Git, committed the project, added a reference to the remote Bitbucket
repository, then pushed everything. I created the repository on Bitbucket before executing these commands.

[source]
----
$ git init
Initialized empty Git repository in /Users/mraible/dev/21-points/.git/

$ git remote add origin git@bitbucket.org:mraible/21-points.git

$ git add -A

$ git commit -m "Initial checkin of 21-points application"
[master (root-commit) e9880d7] Initial checkin of 21-points application
 364 files changed, 24719 insertions(+)
 ...

$ git push origin master
Counting objects: 494, done.
Delta compression using up to 8 threads.
Compressing objects: 100% (463/463), done.
Writing objects: 100% (494/494), 470.33 KiB | 0 bytes/s, done.
Total 494 (delta 64), reused 0 (delta 0)
To git@bitbucket.org:mraible/21-points.git
 * [new branch]      master -> master
----

This is how I created a new application with JHipster and checked it into source control. If you're
creating an application following similar steps, I believe there's two common approaches for continuing. The first
involves developing the application, then testing and deploying. The second option is to set up continuous integration,
deploy, then begin development and testing. In a team development environment, I recommend the second option.
However, since you're likely reading this as an individual, I'll follow the first approach and get right to coding.
If you're interested in setting up continuous integration with Jenkins, please see
https://jhipster.github.io/setting-up-ci-jenkins2/[Setting up Continuous Integration on Jenkins 2].

== Building the UI and business logic

I wanted 21-Points Health to be a bit more hip than a stock JHipster application. Bootstrap was all the rage a couple of years ago,
but now Google's https://www.google.com/design/[Material Design] is growing in popularity. I searched for "material" in the
https://jhipster.github.io/modules/marketplace/[JHipster Marketplace] the
https://jhipster.github.io/modules/marketplace/#/details/generator-jhipster-bootstrap-material-design[Bootstrap Material Design]
module. To install it, I executed the following commands.

[source]
----
npm install -g generator-jhipster-bootstrap-material-design
yo jhipster-bootstrap-material-design
----

The second command yielded a number of questions about overwriting files and I agreed.

----
$ yo jhipster-bootstrap-material-design

     _-----_
    |       |    .--------------------------.
    |--(o)--|    |  Welcome to the JHipster |
   `---------´   |    Bootstrap Material    |
    ( _´U`_ )    | design generator! v3.5.1 |
    /___A___\    '--------------------------'
     |  ~  |     '--------------------------'
   __'.___.'__
 ´   `  |° ´ Y `

? Do you want to install Bootstrap Material design? Yes
Composing JHipster configuration with module bootstrap-material-design
Reading the JHipster project configuration for your module
 conflict bower.json
? Overwrite bower.json? overwrite
    force bower.json
   create src/main/webapp/app/blocks/config/bootstrap-material.config.js
 conflict src/main/webapp/scss/main.scss
? Overwrite src/main/webapp/scss/main.scss? overwrite
    force src/main/webapp/scss/main.scss
 conflict src/main/webapp/content/css/main.css
? Overwrite src/main/webapp/content/css/main.css? overwrite
    force src/main/webapp/content/css/main.css
----

In the terminal log, I noticed a message:

----
You are using SASS! Please make sure to check the documentation on using SASS:
https://github.com/moifort/generator-jhipster-bootstrap-material-design
----

I visited the https://github.com/moifort/generator-jhipster-bootstrap-material-design[module's documentation] and learned
about the changes I needed to make in `index.html`.

[[using-sass]]
.Using SASS
****
When you use sass you need to modify your index.html a little bit to make sure material design styles are not overwritten by default bootstrap styles again:

[source,html]
----
<!-- build:css content/css/vendor.css -->
<link rel="stylesheet" href="content/css/vendor.css">
<!-- bower:css -->
<link rel="stylesheet" href="bower_components/angular-loading-bar/build/loading-bar.css">
<link rel="stylesheet" href="bower_components/bootstrap-material-design/dist/css/bootstrap-material-design.css">
<link rel="stylesheet" href="bower_components/bootstrap-material-design/dist/css/ripples.css">
<!-- endinject -->
<!-- endbuild -->
----

You should make sure that the `vendor.css` is before all material design stylesheets in your index.html!
****

After making these changes, I observed the changes made by installing this module using `git diff`.

Finally, I ran `./gradlew` and confirmed that the new theme was being used.

[[img-material-design-theme]]
.Material Design for Bootstrap theme
image::chapter2/material-design-theme.png[Material Design for Bootstrap theme, 1307, scaledwidth=100%]

Before creating the entities and associated database tables for this application, I decided to upgrade JHipster to
the latest release. You can see that I created this application with JHipster 3.5.1. The latest release as of writing is
3.7.0, so I updated my version with the following command.

----
npm install -g generator-jhipster@latest
----

This installs the latest version of JHipster, but does nothing to upgrade my project. I had to run the following
command to update the project.

----
yo jhipster
----

This notified me that it was deleting a number of files, and there were some conflicts in my files.

TIP: If you don't see conflicts when upgrading, it's possible that you didn't install JHipster on the machine you're using.
This happened to me when I switched machines. Check `package.json` to ensure it has the new version number. If it does not, run
`npm install generator-jhipster@latest --save`.

----
This is an existing project, using the configuration from your .yo-rc.json file
to re-generate the project...


Installing languages: en, fr
 conflict bower.json
? Overwrite bower.json? (Ynaxdh)
----

I answered "`Y`" to all the conflict questions. Because I had the files in source control, I was able to diff the changes
after they were made and decide if I wanted them or not. When I tried to start the app, I did experience a `ConflictingBeanDefinitionException`
exception for `userMapperImpl`. I was able to solve this by deleting `org/jhipster/health/web/rest/mapper/UserMapper.java`.

I ran `gulp` to verify that everything looked good, and saw the following error in my console:

----
bootstrap-material.config.js:8 Uncaught ReferenceError: compileServiceConfig is not defined
----

I opened `bootstrap-material.config.js` to look for the problem.

----
    angular
        .module('21PointsApp')
        .config(bootstrapMaterialDesignConfig);

    compileServiceConfig.$inject = [];

    function bootstrapMaterialDesignConfig() {
        $.material.init();
    }
----

I changed `compileServiceConfig.$inject = [];` to `bootstrapMaterialDesignConfig.$inject = []` and it cleaned up
my console. I then https://github.com/moifort/generator-jhipster-bootstrap-material-design/issues/15[logged an issue] for this bug.

After making this change, I committed my updated project to Git. Then I ran `./gradlew test` to make sure all unit
tests passed. I followed this up with `./gradlew` in one terminal window and `gulp itest` (in the same directory)
in another.

----
10 specs, 0 failures
Finished in 33.065 seconds
[00:35:55] I/launcher - 0 instance(s) of WebDriver still running
[00:35:55] I/launcher - firefox #01 passed
[00:35:55] Finished 'protractor' after 37 s
[00:35:55] Starting 'itest'...
[00:35:55] Finished 'itest' after 28 μs
[mraible:~/dev/21-points] master(+321/-400) 40s $
----

I opened the application in a browser and noticed there were some rounded corners and the primary buttons looked funny.
This happened because the upgrade overwrite `index.html` and I had to re-apply the <<using sass>> fix.

TIP: After integrating the Material Design theme, I deployed to Heroku for the first time. This is covered in the
<<Deploying to Heroku>> section of this chapter.

=== Generating entities

For each entity you want to create, you will need:

* a database table;
* a Liquibase change set;
* a JPA entity class;
* a Spring Data `JpaRepository` interface;
* a Spring MVC `RestController` class;
* an AngularJS router, controller and service; and
* a HTML page.

In addition, you should have integration tests to verify that everything works and performance tests to verify that it runs fast. In
an ideal world, you'd also have unit tests and integration tests for your Angular code.

The good news is JHipster can generate all of this code for you, including integration tests and performance tests. In addition,
if you have entities with relationships, it will generate the necessary schema to support them (with foreign keys), and the
JavaScript and HTML code to manage them. You can also set up validation to require certain fields as well as control their length.

JHipster supports several methods of code generation. The first uses its
https://jhipster.github.io/creating-an-entity/[entity sub-generator]. The entity sub-generator is a command-line tool
that prompts you with questions which you answer. https://jhipster.github.io/jdl-studio/[JDL-Studio] is a browser-based
tool for defining your domain model with JHipster Domain Language (JDL). Finally, https://jhipster.github.io/jhipster-uml/[JHipster UML]
is an option for those that like UML. Supported UML editors include https://www.modeliosoft.com/[Modelio],
http://www.umldesigner.org/[UML Designer], https://www.genmymodel.com/[GenMyModel] and
http://www.visual-paradigm.com/[Visual Paradigm]. Because the entity sub-generator is one of the simplest to use, I chose
that for this project.

TIP: If you want to see how how easy it is to use JDL-Studio, please see https://youtu.be/kkHN2G_nXV0?t=1460[this YouTube demo].

At this point, I did some trail-and-error designs with the data model. I generated entities with JHipster, tried the app, and
changed to start with a UI-first approach. As a user, I was hoping to easily add daily entries about whether I'd exercised,
ate healthy meals, or consumed alcohol. I also wanted to record my weight and blood-pressure metrics when I measured them.
When I started using the UI I'd just created, it seemed like it might be able to accomplish these goals, but it also seemed
somewhat cumbersome. That's when I decided to create a UI mockup with the main screen and its ancillary screens for data entry. I used
https://www.omnigroup.com/omnigraffle[OmniGraffle] and a https://viget.com/inspire/twitter-bootstrap-3.0-stencils-for-omnigraffle[Bootstrap stencil] to create the following UI mockup.

[[img-ui-mockup]]
.UI mockup
image::chapter2/ui-mockup.png[UI mockup, 846, scaledwidth=75%, align=center]

After figuring out how I wanted the UI to look, I started to think about the data model. I quickly decided I didn't need to
track high-level goals (e.g. lose five pounds in Q4 2016). I was more concerned with tracking weekly goals and 21-Points
Health is all about how many points you get in a week. I created the following diagram as my data model.

[[img-entity-diagram]]
.21-Points Health entity diagram
image::chapter2/entity-diagram.png[21-Points Health entity diagram, 684, scaledwidth=100%, align=center]

I ran `yo jhipster:entity points`. I added the appropriate fields and their validation rules, and specified a many-to-one
relationship with `User`. Below is the final output from my answers.

----
================= Points =================
Fields
date (LocalDate) required
exercise (Integer)
meals (Integer)
alcohol (Integer)
notes (String) maxlength='140'

Relationships
user (User) many-to-one

? Do you want to use a Data Transfer Object (DTO)? No, use the entity directly
? Do you want to use separate service class for your business logic? No, the REST controller should use the repository d
irectly
? Do you want pagination on your entity? Yes, with infinite scroll

Everything is configured, generating the entity...

   create .jhipster/Points.json
   create src/main/java/org/jhipster/health/domain/Points.java
   create src/main/java/org/jhipster/health/repository/PointsRepository.java
   create src/main/java/org/jhipster/health/repository/search/PointsSearchRepository.java
   create src/main/java/org/jhipster/health/web/rest/PointsResource.java
   create src/main/resources/config/liquibase/changelog/20160831020048_added_entity_Points.xml
   create src/main/resources/config/liquibase/changelog/20160831020048_added_entity_constraints_Points.xml
 conflict src/main/resources/config/liquibase/master.xml
? Overwrite src/main/resources/config/liquibase/master.xml? overwrite this and all others
    force src/main/resources/config/liquibase/master.xml
   create src/main/webapp/app/entities/points/points.html
   create src/main/webapp/app/entities/points/points-detail.html
   create src/main/webapp/app/entities/points/points-dialog.html
   create src/main/webapp/app/entities/points/points-delete-dialog.html
    force src/main/webapp/app/layouts/navbar/navbar.html
   create src/main/webapp/app/entities/points/points.state.js
   create src/main/webapp/app/entities/points/points.controller.js
   create src/main/webapp/app/entities/points/points-dialog.controller.js
   create src/main/webapp/app/entities/points/points-delete-dialog.controller.js
   create src/main/webapp/app/entities/points/points-detail.controller.js
   create src/main/webapp/app/entities/points/points.service.js
   create src/main/webapp/app/entities/points/points.search.service.js
   create src/main/webapp/i18n/en/points.json
    force src/main/webapp/i18n/en/global.json
   create src/main/webapp/i18n/fr/points.json
    force src/main/webapp/i18n/fr/global.json
   create src/test/javascript/spec/app/entities/points/points-detail.controller.spec.js
   create src/test/javascript/e2e/entities/points.js
   create src/test/java/org/jhipster/health/web/rest/PointsResourceIntTest.java
   create src/test/gatling/simulations/PointsGatlingTest.scala

Running gulp Inject to add javascript to index
----

I had similar answers for the `Weight` and `BloodPressure` entities. For `Preferences`, I created a one-to-one relationship
with `User`.

To ensure that people use 21-Points Health effectively, I set the weekly goal to a minimum of 10 points and a max of 21. I also
made the `weightUnits` property an enum.

----
================= Preferences =================
Fields
weekly_goal (Integer) required min='10' max='21'

Generating field #2
? Do you want to add a field to your entity? Yes
? What is the name of your field? weight_units
? What is the type of your field? Enumeration (Java enum type)
? What is the class name of your enumeration? Units
? What are the values of your enumeration (separated by comma)? kg,lb
? Do you want to add validation rules to your field? Yes
? Which validation rules do you want to add? Required

================= Preferences =================
Fields
weekly_goal (Integer) required min='10' max='21'
weight_units (Units) required
----

TIP: After generating the `Weight` and `BloodPressure` entities with a `date` property for the date/time field, I
decided that `timestamp` was a better property name. To fix this, I modified the respective JSON files in the `.jhipster`
directory and ran `yo jhipster:entity` for each entity again. This seemed easier than refactoring with IntelliJ and hoping
it caught all the name instances.

When I ran `./gradlew test`, I was pleased to see that all tests passed.

----
BUILD SUCCESSFUL

Total time: 17.64 secs
----

I checked in four changed files and 99 new files generated by the JHipster before continuing to implement my UI mockups.

== Application improvements

To make my new JHipster application into something I could be proud of, I made a number of improvements, described below.

TIP: At this point, I set up continuous testing of this project using https://jenkins-ci.org/[Jenkins]. This is covered
in the <<Continuous integration and deployment>> section of this chapter.

=== Fixed issues with variable names

For the `Preferences` entity, I specified `weekly_goals` and `weight_unit` as field names. I was thinking in terms
of names for database columns when I chose these names. I later learned that these names were used throughout my code. I left
the column names intact and manually renamed everything in Java, JavaScript, JSON, and HTML to `weeklyGoals` and `weightUnit`.

=== Improved HTML layout and I18N messages

Of all the code I write, UI code (HTML, JavaScript, and CSS) is my favorite. I like that you can see changes
immediately and make progress quickly - especially when you're using dual monitors with
ifdef::backend-epub3[link:jhipsters-ui-components.xhtml#Browsersync[Browsersync].]
ifndef::backend-epub3[<<Browsersync>>.]
Below is a consolidated list of changes I made to the HTML to make things look better:

. Improved layout of tables and buttons.
. Improved titles and button labels by editing generated JSON files in `src/main/webapp/i18n/en`.
. Formatted dates for local timezone https://docs.angularjs.org/api/ng/filter/date[AngularJS's date filter]
  (for example: `{{bloodPressure.timestamp | date: 'short': 'UTC'}}`).
. Improved dialogs to hide ID when creating a new entity.
. Defaulted to current date on new entries.
. Replaced point metrics with icons on list/detail screens.
. Replaced point metrics with checkboxes on dialog screen.

The biggest visual improvements are on the list screens. I made the buttons a bit smaller, turned button text into tooltips,
and moved add/search buttons to the top right corner. For the points-list screen, I converted the 1 and 0 metric values
to icons. Before and after screenshots of the points list illustrate the improved, compact layout.

[[img-points-list-before]]
.Default Daily Points list
image::chapter2/points-list-before.png[Default Daily Points list, 1322, scaledwidth=100%, align=center]

[[img-points-list-after]]
.Default Daily Points list after UI improvements
image::chapter2/points-list-after.png[Default Daily Points list after UI improvements, 1322, scaledwidth=100%, align=center]

I refactored the HTML at the top of `points.html` to put the title, search, and add buttons on the same row. I also removed
the button text in favor of a using https://angular-ui.github.io/bootstrap/#/tooltip[UI Bootstrap's tooltip directive].
The `translate` filter you see in the button titles is provided by https://angular-translate.github.io/[Angular Translate].
Both UI Bootstrap and Angular Translate are included in JHipster by default.

[source,html]
.src/main/webapp/app/entities/points/points.html
----
<div class="row">
    <div class="col-sm-7">
        <h2 translate="21PointsApp.points.home.title">Points</h2>
    </div>
    <div class="col-sm-5 text-right p-n">
        <form name="searchForm" class="form-inline">
            <div class="form-group m-n">
                <input type="search" class="form-control" ng-model="vm.searchQuery" id="searchQuery"
                       placeholder="{{'entity.action.search' | translate}}">
            </div>
            <button class="btn btn-info btn-sm" ng-click="vm.clear()" ng-if="vm.currentSearch">
                <span class="glyphicon glyphicon-trash"></span>
            </button>
            <button class="btn btn-info btn-sm btn-raised" ng-click="vm.search(vm.searchQuery)"
                    uib-tooltip="{{'entity.action.search' | translate}}">
                <i class="glyphicon glyphicon-search"></i>
            </button>
            <button class="btn btn-primary btn-sm btn-raised" ui-sref="points.new"
                    uib-tooltip="{{'entity.action.new' | translate}}">
                <span class="glyphicon glyphicon-plus"></span>
            </button>
        </form>
    </div>
</div>
----

Changing the numbers to icons was pretty easy thanks to Angular's `ng-class` directive.

[source,html]
.src/main/webapp/app/entities/points/points.html
----
<td class="text-center">
    <i class="glyphicon"
       ng-class="{'glyphicon-ok text-success': points.exercise,
                  'glyphicon-remove text-danger': !points.exercise}"></i>
</td>
<td class="text-center">
    <i class="glyphicon"
       ng-class="{'glyphicon-ok text-success': points.meals,
                  'glyphicon-remove text-danger': !points.meals}"></i>
</td>
<td class="text-center">
    <i class="glyphicon"
       ng-class="{'glyphicon-ok text-success': points.alcohol,
                 'glyphicon-remove text-danger': !points.alcohol}"></i>
</td>
----

Similarly, I changed the input fields to checkboxes in `points-dialog.html`. Angular's `ng-true-value`
and `ng-false-value` made it easy to continue receiving/sending integers to the API.

[source,html]
.src/main/webapp/app/entities/points/points-dialog.html
----
<div class="form-group">
    <div class="checkbox">
        <label>
            <input type="checkbox" ng-model="vm.points.exercise" id="field_exercise"
                   ng-true-value="1" ng-false-value="0">
            <span class="check"></span>
            <label data-translate="21PointsApp.points.exercise" for="field_exercise" class="control-label">Exercise</label>
        </label>
    </div>
</div>
----

After making this change, you can see that the "`Add Points`" screen is starting to look like the UI mockup
I created.

[[img-add-points-dialog]]
.Add Points dialog
image::chapter2/add-points-dialog.png[Add Points dialog, 892, scaledwidth=80%, align=center]

Improving the UI was the most fun, but also the most time consuming as it involved lots of little tweaks to
multiple screens. The next task was more straightforward: implementing business logic.

=== Added logic so non-admin users only see their own data

I wanted to make several improvements to what users could see, based on their roles. A user should be able to see
and modify their data, but nobody else's. I also wanted to ensure that an administrator could see and modify
everyone's data.

==== Hide user selection from non-admin users

The default dialogs for many-to-one relationships allow you to choose the user when you add/edit a record. To make
it so only administrators had this ability, I modified the dialog screens and used the `has-authority` directive. This
directive is included with JHipster, in `src/main/webapp/app/services/auth/has-authority.directive.js`. It also has
a `has-any-authority` directive that allows you to pass in a comma-delimited list of roles.

[source,html]
.src/main/webapp/app/entities/points/points-dialog.html
----
<div class="form-group" has-authority="ROLE_ADMIN">
    <label class="control-label" data-translate="21PointsApp.points.user" for="field_user">User</label>
    <select class="form-control" id="field_user" name="user" ng-model="vm.points.user" ng-options="user as user.login for user in vm.users track by user.id">
        <option value=""></option>
    </select>
</div>
----

Since the dropdown is hidden from non-admins, I had to modify each Resource class to default to the current user when
creating a new record. Below is a diff that shows the changes that I needed to make to `PointsResource.java`.

[source,diff]
.src/main/java/org/jhipster/health/web/rest/PointsResource.java
----
     @Inject
     private PointsSearchRepository pointsSearchRepository;

+    @Inject
+    private UserRepository userRepository;
+
     /**
      * POST  /points : Create a new points.
      *
@@ -59,6 +67,10 @@ public class PointsResource {
         if (points.getId() != null) {
             return ResponseEntity.badRequest().headers(HeaderUtil.createFailureAlert("points", "idexists", "A new points cannot already have an ID")).body(null);
         }
+        if (!SecurityUtils.isCurrentUserInRole(AuthoritiesConstants.ADMIN)) {
+            log.debug("No user passed in, using current user: {}", SecurityUtils.getCurrentUserLogin());
+            points.setUser(userRepository.findOneByLogin(SecurityUtils.getCurrentUserLogin()).get());
+        }
         Points result = pointsRepository.save(points);
         pointsSearchRepository.save(result);
----

`SecurityUtils` is a class JHipster provides when you create a project. I had to modify `PointsResourceIntTest.java` to
be security-aware after making this change.

Spring MVC Test provides a convenient interface called `RequestPostProcessor` that you can use to modify a request.
Spring Security provides a number of `RequestPostProcessor` implementations that simplify testing. In order to use
Spring Security’s `RequestPostProcessor` implementations, you can include them all with the following static import.

[source,java]
----
import static org.springframework.security.test.web.servlet.request.SecurityMockMvcRequestPostProcessors.*;
----

I then modified `PointsResourceIntTest.java`, creating a new `MockMvc` instance that was security-aware and
specified `with(user("user"))` to populate Spring Security's `SecurityContext` with an authenticated user.

[source,diff]
.src/test/java/org/jhipster/health/web/rest/PointsResourceIntTest.java
----
+import org.jhipster.health.repository.UserRepository;
+import org.springframework.beans.factory.annotation.Autowired;
+import org.springframework.web.context.WebApplicationContext;
+import static org.springframework.security.test.web.servlet.request.SecurityMockMvcRequestPostProcessors.user;
+import static org.springframework.security.test.web.servlet.setup.SecurityMockMvcConfigurers.springSecurity;

@@ -55,6 +63,9 @@
     @Inject
+    private UserRepository userRepository;
+
+    @Inject
     private PointsRepository pointsRepository;

     @Inject
@@ -69,6 +80,9 @@ public class PointsResourceIntTest {
     @Inject
     private EntityManager em;

+    @Inject
+    private WebApplicationContext context;
+
     private MockMvc restPointsMockMvc;

     private Points points;

@@ -79,6 +93,7 @@
         PointsResource pointsResource = new PointsResource();
         ReflectionTestUtils.setField(pointsResource, "pointsSearchRepository", pointsSearchRepository);
         ReflectionTestUtils.setField(pointsResource, "pointsRepository", pointsRepository);
+        ReflectionTestUtils.setField(pointsResource, "userRepository", userRepository);
         this.restPointsMockMvc = MockMvcBuilders.standaloneSetup(pointsResource)
             .setCustomArgumentResolvers(pageableArgumentResolver)
             .setMessageConverters(jacksonMessageConverter).build();

@@ -112,9 +127,15 @@
     public void createPoints() throws Exception {
         int databaseSizeBeforeCreate = pointsRepository.findAll().size();

-        // Create the Points
+        // Create security-aware mockMvc
+        restPointsMockMvc = MockMvcBuilders
+            .webAppContextSetup(context)
+            .apply(springSecurity())
+            .build();

+        // Create the Points
         restPointsMockMvc.perform(post("/api/points")
+                .with(user("user"))
                 .contentType(TestUtil.APPLICATION_JSON_UTF8)
                 .content(TestUtil.convertObjectToJsonBytes(points)))
                 .andExpect(status().isCreated());
----

==== List screen should show only user's data

The next business-logic improvement I wanted was to modify list screens so they'd only show records for current user. Admin
users should see all users' data. To facilitate this feature, I modified `PointsResource#getAll` to have a switch based on the user's role.

[source,java]
.src/main/java/org/jhipster/health/web/rest/PointsResource.java
----
public ResponseEntity<List<Points>> getAllPoints(Pageable pageable) throws URISyntaxException {
    log.debug("REST request to get a page of Points");
    Page<Points> page;
    if (SecurityUtils.isCurrentUserInRole(AuthoritiesConstants.ADMIN)) {
        page = pointsRepository.findAllByOrderByDateDesc(pageable);
    } else {
        page = pointsRepository.findByUserIsCurrentUser(pageable);
    }

    HttpHeaders headers = PaginationUtil.generatePaginationHttpHeaders(page, "/api/points");
    return new ResponseEntity<>(page.getContent(), headers, HttpStatus.OK);
}
----

The `PointsRepository#findByUserIsCurrentUser()` method that JHipster generated contains a custom query that uses Spring Expression Language
to grab the user's information from Spring Security. I changed it from returning a `List<Points>` to returning `Page<Points>`.

[source,java]
.src/main/java/org/jhipster/health/repository/PointsRepository.java
----
@Query("select points from Points points where points.user.login = ?#{principal.username}")
Page<Points> findByUserIsCurrentUser(Pageable pageable);
----

[sidebar]
.Ordering by date
--
Later on, I changed the above query to order by date, so the first records in the list would be the most recent.

[source,java]
.src/main/java/org/jhipster/health/repository/PointsRepository.java
----
@Query("select points from Points points where points.user.login = ?#{principal.username} order by points.date desc")
----

In addition, I changed the call to `pointsRepository.findAll` to `pointsRepository.findAllByOrderByDateDesc` so the admin
user's query would order by date. The query for this is generated dynamically by Spring Data, simply by adding the method to your repository.

[source,java]
----
Page<Points> findAllByOrderByDateDesc(Pageable pageable);
----
--

To make tests pass, I had to update `PointsResourceIntTest#getAllPoints` to use Spring Security Test's `user` post processor.

[source,diff]
.src/test/java/org/jhipster/health/web/rest/PointsResourceIntTest.java
----
 @Test
 @Transactional
 public void getAllPoints() throws Exception {
     // Initialize the database
     pointsRepository.saveAndFlush(points);

+    // Create security-aware mockMvc
+    restPointsMockMvc = MockMvcBuilders
+        .webAppContextSetup(context)
+        .apply(springSecurity())
+        .build();
+
     // Get all the points
-    restPointsMockMvc.perform(get("/api/points?sort=id,desc"))
+    restPointsMockMvc.perform(get("/api/points?sort=id,desc")
+            .with(user("admin").roles("ADMIN")))
             .andExpect(status().isOk())
----

=== Implementing the UI mockup

Making the homepage into something resembling my UI mockup required several steps:

. Adding buttons to facilitate adding new data from the homepage.
. Adding an API to get points achieved during the current week.
. Adding an API to get blood-pressure readings for the last 30 days.
. Adding an API to get body weights for the last 30 days.
. Adding charts to display points per week, and blood pressure/weight for last 30 days.

I started by reusing the dialogs for entering data that JHipster had created for me. I found that adding new
routes to `home.state.js` was the easiest way to do this. Instead of routing back to the list screen after a save
succeeded, I routed the user back to the `home` state. I copied the generated `points.new` state from `points.state.js`
and pasted it into `home.state.js`.

[source,javascript]
.src/main/webapp/app/home/home.state.js
----
.state('points.add', { <1>
    parent: 'home', <2>
    url: 'add/points', <3>
    data: {
        authorities: ['ROLE_USER']
    },
    onEnter: ['$stateParams', '$state', '$uibModal', function($stateParams, $state, $uibModal) {
        $uibModal.open({
            templateUrl: 'app/entities/points/points-dialog.html',
            controller: 'PointsDialogController',
            controllerAs: 'vm',
            backdrop: 'static',
            size: 'lg',
            resolve: {
                entity: function () {
                    return {date: null, exercise: null, meals: null, alcohol: null, notes: null, id: null};
                }
            }
        }).result.then(function() { <4>
            $state.go('home', null, { reload: true });
        }, function() {
            $state.go('home');
        });
    }]
});
----
<1> I changed from 'points.new' to 'points.add'.
<2> I changed the parent to be 'home'.
<3> I changed the `url` from '/new' to 'add/points'.
<4> I changed both result states to be 'home' instead of 'points'.

After configuring the state to add new points from the homepage, I added a button to activate the dialog.

[source,html]
.src/main/webapp/app/home/home.html
----
<a ui-sref="points.add" class="btn btn-primary btn-raised">Add Points</a>
----

I fired up the application to test the button and dialog and discovered that the messages in the dialog were not
translated. I fixed this by adding `$translatePartialLoader.addPart('points')` to the `home` state in `home.state.js`:

[source,javascript]
.src/main/webapp/app/home/home.state.js
----
resolve: {
    mainTranslatePartialLoader: ['$translate', '$translatePartialLoader', function ($translate,$translatePartialLoader) {
        $translatePartialLoader.addPart('home');
        $translatePartialLoader.addPart('points');
        return $translate.refresh();
    }]
}
----

==== Points this week

To get points achieved in the current week, I started by adding a unit test to `PointsResourceIntTest.java` that
would allow me to prove my API was working.

[source,java]
.src/test/java/org/jhipster/health/web/rest/PointsResourceIntTest.java
----
private void createPointsByWeek(LocalDate thisMonday, LocalDate lastMonday) {
    User user = userRepository.findOneByLogin("user").get();
    // Create points in two separate weeks
    points = new Points(thisMonday.plusDays(2), 1, 1, 1, user); <1>
    pointsRepository.saveAndFlush(points);

    points = new Points(thisMonday.plusDays(3), 1, 1, 0, user);
    pointsRepository.saveAndFlush(points);

    points = new Points(lastMonday.plusDays(3), 0, 0, 1, user);
    pointsRepository.saveAndFlush(points);

    points = new Points(lastMonday.plusDays(4), 1, 1, 0, user);
    pointsRepository.saveAndFlush(points);
}

public void getPointsThisWeek() throws Exception {
    LocalDate today = LocalDate.now();
    LocalDate thisMonday = today.with(DayOfWeek.MONDAY);
    LocalDate lastMonday = thisMonday.minusWeeks(1);
    createPointsByWeek(thisMonday, lastMonday);

    // create security-aware mockMvc
    restPointsMockMvc = MockMvcBuilders
        .webAppContextSetup(context)
        .apply(springSecurity())
        .build();

    // Get all the points
    restPointsMockMvc.perform(get("/api/points")
        .with(user("user").roles("USER")))
        .andExpect(status().isOk())
        .andExpect(content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON))
        .andExpect(jsonPath("$", hasSize(4)));

    // Get the points for this week only
    restPointsMockMvc.perform(get("/api/points-this-week")
        .with(user("user").roles("USER")))
        .andExpect(status().isOk())
        .andExpect(content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON))
        .andExpect(jsonPath("$.week").value(thisMonday.toString()))
        .andExpect(jsonPath("$.points").value(5));
}
----
<1> To simplify testing, I added a new constructor to `Points.java` that contained the arguments I wanted to set. I
    continued this pattern for most tests I created.

Of course, this test failed when I first ran it since "`/api/points-this-week`" didn't exist in `PointsResource.java`.
You might notice the points-this-week API expects two return values: a date in the `week` field and the number
of points in the `points` field. I created `PointsPerWeek.java` in my project's `rest.vm` package to hold this
information.

[source,java]
.src/main/java/org/jhipster/health/web/rest/vm/PointsPerWeek.java
----
package org.jhipster.health.web.rest.vm;

import java.time.LocalDate;

public class PointsPerWeek {
    private LocalDate week;
    private Integer points;

    public PointsPerWeek(LocalDate week, Integer points) {
        this.week = week;
        this.points = points;
    }

    public Integer getPoints() {
        return points;
    }

    public void setPoints(Integer points) {
        this.points = points;
    }

    public LocalDate getWeek() {
        return week;
    }

    public void setWeek(LocalDate week) {
        this.week = week;
    }

    @Override
    public String toString() {
        return "PointsThisWeek{" +
            "points=" + points +
            ", week=" + week +
            '}';
    }
}
----

Spring Data JPA made it easy to find all point entries in a particular week. I added a new method
to my `PointsRepository.java` that allowed me to query between two dates.

[source,java]
.src/main/java/org/jhipster/health/repository/PointsRepository.java
----
List<Points> findAllByDateBetween(LocalDate firstDate, LocalDate secondDate);
----

From there, it was just a matter of calculating the beginning and end of the current week and processing the data
in `PointsResource.java`.

[source,java]
.src/main/java/org/jhipster/health/web/rest/PointsResource.java
----
/**
 * GET  /points -> get all the points for the current week.
 */
@RequestMapping(value = "/points-this-week")
@Timed
public ResponseEntity<PointsPerWeek> getPointsThisWeek() {
    // Get current date
    LocalDate now = LocalDate.now();
    // Get first day of week
    LocalDate startOfWeek = now.with(DayOfWeek.MONDAY);
    // Get last day of week
    LocalDate endOfWeek = now.with(DayOfWeek.SUNDAY);
    log.debug("Looking for points between: {} and {}", startOfWeek, endOfWeek);

    List<Points> points = pointsRepository.findAllByDateBetween(startOfWeek, endOfWeek);
    // filter by current user and sum the points
    Integer numPoints = points.stream()
        .filter(p -> p.getUser().getLogin().equals(SecurityUtils.getCurrentUserLogin()))
        .mapToInt(p -> p.getExercise() + p.getMeals() + p.getAlcohol())
        .sum();

    PointsPerWeek count = new PointsPerWeek(startOfWeek, numPoints);
    return new ResponseEntity<>(count, HttpStatus.OK);
}
----

To support this new method on the client, I added a new method to my `Points` service.

[source,javascript]
.src/main/webapp/app/entities/points/points.service.js
----
function Points ($resource, DateUtils) {
    var resourceUrl =  'api/points/:id';

    return $resource(resourceUrl, {}, {
        'query': { method: 'GET', isArray: true},
        'thisWeek': { method: 'GET', isArray: false, url: 'api/points-this-week'},
        ...
    });
}
----

Then I added the service to `home.controller.js` and calculated the data I wanted to display.

[source,javascript]
.src/main/webapp/app/home/home.controller.js
----
function HomeController ($scope, Principal, LoginService, Points, $state) {
    var vm = this;

    ...

    function getAccount() {
        Principal.identity().then(function(account) {
            vm.account = account;
            vm.isAuthenticated = Principal.isAuthenticated;
        });

        Points.thisWeek(function(data) {
            vm.pointsThisWeek = data;
            vm.pointsPercentage = (data.points / 21) * 100;
        });
    }
}
----

I added a Bootstrap progress bar to `home.html` to show points-this-week progress.

[source,html]
.src/main/webapp/app/main/main.html
----
<div class="row">
    <div class="col-md-10">
        <div class="progress progress-lg" ng-show="vm.pointsThisWeek.points"> <1>
            <div class="progress-bar progress-bar-success progress-bar-striped" role="progressbar"
                 aria-valuenow="{{vm.pointsThisWeek.points}}"
                 aria-valuemin="0" aria-valuemax="21" style="width: {{vm.pointsPercentage}}%">
                {{vm.pointsThisWeek.points}} / Goal: 10
            </div>
        </div>
        <alert type="info" ng-hide="vm.pointsThisWeek.points">
            No points yet this week, better get moving!
        </alert>
    </div>
</div>
----
<1> I later realized this could be replaced with UI Bootstrap's
    https://angular-ui.github.io/bootstrap/#/progressbar[progressbar], but why fix something if it isn't broke?! ;)

Below is a screenshot of what this progress bar looked like after restarting the server and entering some data for the
current user.

[[img-homepage-progress-bar]]
.Progress bar for points this week
image::chapter2/homepage-points-this-week.png[Progress bar for points this week, 1363, scaledwidth=100%, align=center]

You might notice the goal is hardcoded to 10 in the progress bar's HTML. To fix this, I needed to add the ability
to fetch the user's preferences. To make it easier to access a user's preferences, I modified `PreferencesRepository.java` and added
a method to retrieve a user's preferences.

[source,java]
.src/main/java/org/jhipster/health/repository/PreferencesRepository.java
----
public interface PreferencesRepository extends JpaRepository<Preferences,Long> {

    Optional<Preferences> findOneByUserLogin(String login);

}
----

I created a new method in `PreferencesResource.java` to return the user's preferences
(or a default weekly goal of 10 points if no preferences are defined).

[source,java]
.src/main/java/org/jhipster/health/web/rest/PreferencesResource.java
----
/**
 * GET  /my-preferences -> get the current user's preferences.
 */
@RequestMapping(value = "/my-preferences",
    method = RequestMethod.GET,
    produces = MediaType.APPLICATION_JSON_VALUE)
@Timed
public ResponseEntity<Preferences> getUserPreferences() {
    String username = SecurityUtils.getCurrentUserLogin();
    log.debug("REST request to get Preferences : {}", username);
    Optional<Preferences> preferences = preferencesRepository.findOneByUserLogin(username);

    if (preferences.isPresent()) {
        return new ResponseEntity<>(preferences.get(), HttpStatus.OK);
    } else {
        Preferences defaultPreferences = new Preferences();
        defaultPreferences.setWeeklyGoal(10); // default
        return new ResponseEntity<>(defaultPreferences, HttpStatus.OK);
    }
}
----

To facilitate calling this endpoint, I added a new `user` method to the `Preferences` client service.

[source,javascript]
.src/main/webapp/app/entities/preferences/preferences.service.js
----
function Preferences ($resource) {
    var resourceUrl =  'api/preferences/:id';

    return $resource(resourceUrl, {}, {
        'query': { method: 'GET', isArray: true},
        'user': { method: 'GET', isArray: false, url: '/api/my-preferences'}
        ...
    });
}
----

In `home.controller.js`, I added the `Preferences` service as a dependency and set the preferences on `vm`
so the HTML template could read it.

[source,javascript]
.src/main/webapp/app/home/home.controller.js
----
function HomeController ($scope, Principal, LoginService, Points, Preferences, $state) {
    var vm = this;

    ...

    function getAccount() {
        ...

        Preferences.user(function(data) {
            vm.preferences = data;
        });
    }
}
----

Now that a user's preferences were available, I modified `home.html` to display the user's weekly goal, as well
as to color the progress bar appropriately with `ng-class`.

[source,html]
.src/main/webapp/app/home/home.html
----
<div class="progress-bar progress-bar-striped" role="progressbar"
     ng-class="{'progress-bar-success': vm.pointsThisWeek.points >= vm.preferences.weeklyGoal,
                'progress-bar-danger': vm.pointsThisWeek.points < 10,
                'progress-bar-warning': vm.pointsThisWeek.points > 10 && vm.pointsThisWeek.points < vm.preferences.weeklyGoal}"
     aria-valuenow="{{vm.pointsThisWeek.points}}"
     aria-valuemin="0" aria-valuemax="21" style="width: {{vm.pointsPercentage}}%">
    <span ng-show="vm.pointsThisWeek.points">
        {{vm.pointsThisWeek.points}} / Goal: {{vm.preferences.weeklyGoal}}
    </span>
    <span class="sr-only">{{vm.pointsPercentage}} points this week</span>
</div>
----

To finish things off, I added a link to a dialog where users could edit their preferences. I also added an appropriate state to allow editing in `home.state.js`.

==== Blood pressure and weight for the last 30 days

To populate the two remaining charts on the homepage, I needed to fetch the user's blood pressure readings and weights
for the last 30 days. I added a method to `BloodPressureResourceIntTest.java` to set up my expectations.

[source%autofit,java]
.src/test/java/org/jhipster/health/web/rest/BloodPressureResourceIntTest.java
----
private void createBloodPressureByMonth(ZonedDateTime firstDate, ZonedDateTime firstDayOfLastMonth) {
    User user = userRepository.findOneByLogin("user").get();

    bloodPressure = new BloodPressure(firstDate, 120, 80, user);
    bloodPressureRepository.saveAndFlush(bloodPressure);
    bloodPressure = new BloodPressure(firstDate.plusDays(10), 125, 75, user);
    bloodPressureRepository.saveAndFlush(bloodPressure);
    bloodPressure = new BloodPressure(firstDate.plusDays(20), 100, 69, user);
    bloodPressureRepository.saveAndFlush(bloodPressure);

    // last month
    bloodPressure = new BloodPressure(firstDayOfLastMonth, 130, 90, user);
    bloodPressureRepository.saveAndFlush(bloodPressure);
    bloodPressure = new BloodPressure(firstDayOfLastMonth.plusDays(11), 135, 85, user);
    bloodPressureRepository.saveAndFlush(bloodPressure);
    bloodPressure = new BloodPressure(firstDayOfLastMonth.plusDays(23), 130, 75, user);
    bloodPressureRepository.saveAndFlush(bloodPressure);
}

@Test
@Transactional
public void getBloodPressureForLast30Days() throws Exception {
    ZonedDateTime now = ZonedDateTime.now();
    ZonedDateTime twentyNineDaysAgo = now.minusDays(29);
    ZonedDateTime firstDayOfLastMonth = now.withDayOfMonth(1).minusMonths(1);
    createBloodPressureByMonth(twentyNineDaysAgo, firstDayOfLastMonth);

    // create security-aware mockMvc
    restBloodPressureMockMvc = MockMvcBuilders
        .webAppContextSetup(context)
        .apply(springSecurity())
        .build();

    // Get all the blood pressure readings
    restBloodPressureMockMvc.perform(get("/api/blood-pressures")
        .with(user("user").roles("USER")))
        .andExpect(status().isOk())
        .andExpect(content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON))
        .andExpect(jsonPath("$", hasSize(6)));

    // Get the blood pressure readings for the last 30 days
    restBloodPressureMockMvc.perform(get("/api/bp-by-days/{days}", 30)
        .with(user("user").roles("USER")))
        .andDo(print())
        .andExpect(status().isOk())
        .andExpect(content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON))
        .andExpect(jsonPath("$.period").value("Last 30 Days"))
        .andExpect(jsonPath("$.readings.[*].systolic").value(hasItem(120)))
        .andExpect(jsonPath("$.readings.[*].diastolic").value(hasItem(69)));
}
----

I created a `BloodPressureByPeriod.java` class to return the results from the API.

[source,java]
.src/main/java/org/jhipster/health/web/rest/vm/BloodPressureByPeriod.java
----
public class BloodPressureByPeriod {
    private String period;
    private List<BloodPressure> readings;

    public BloodPressureByPeriod(String period, List<BloodPressure> readings) {
        this.period = period;
        this.readings = readings;
    }
    ...
}
----

Using similar logic that I used for points-this-week, I created a new method in `BloodPressureRepository.java` that
allowed me to query between two different dates. I also added "`orderBy`" logic so the records would be sorted by date
entered.

[source,java]
.src/main/java/org/jhipster/health/repository/BloodPressureRepository.java
----
List<BloodPressure> findAllByTimestampBetweenOrderByTimestampDesc(ZonedDateTime firstDate, ZonedDateTime secondDate);
----

Next, I created a new method in `BloodPressureResource.java` that calculated the first and last days of the current
month, executed the query for the current user, and constructed the data to return.

[source,java]
.src/main/java/org/jhipster/health/web/rest/BloodPressureResource.java
----
/**
 * GET  /bp-by-days : get all the blood pressure readings by last x days.
 */
@RequestMapping(value = "/bp-by-days/{days}")
@Timed
public ResponseEntity<BloodPressureByPeriod> getByDays(@PathVariable int days) {
    ZonedDateTime rightNow = ZonedDateTime.now();
    ZonedDateTime daysAgo = rightNow.minusDays(days);

    List<BloodPressure> readings = bloodPressureRepository.findAllByTimestampBetweenOrderByTimestampDesc(daysAgo, rightNow);
    BloodPressureByPeriod response = new BloodPressureByPeriod("Last " + days + " Days", filterByUser(readings));
    return new ResponseEntity<>(response, HttpStatus.OK);
}

private List<BloodPressure> filterByUser(List<BloodPressure> readings) {
    Stream<BloodPressure> userReadings = readings.stream()
        .filter(bp -> bp.getUser().getLogin().equals(SecurityUtils.getCurrentLogin()));
    return userReadings.collect(Collectors.toList());
}
----

[NOTE]
====
I later learned how do do the filtering in in the database by adding the following method to `BloodPressureRepository.java`:

[source,java]
.src/main/java/org/jhipster/health/repository/BloodPressureRepository.java
----
List<BloodPressure> findAllByTimestampBetweenAndUserLoginOrderByTimestampDesc(ZonedDateTime firstDate, ZonedDateTime secondDate, String login);
----

Then I was able to remove the `filterByUser` method and change `BloodPressureResource#getByDays` to be:

[source,java]
.src/main/java/org/jhipster/health/web/rest/BloodPressureResource.java
----
public ResponseEntity<BloodPressureByPeriod> getByDays(@PathVariable int days) {
    ZonedDateTime rightNow = ZonedDateTime.now();
    ZonedDateTime daysAgo = rightNow.minusDays(days);

    List<BloodPressure> readings =
        bloodPressureRepository.findAllByTimestampBetweenAndUserLoginOrderByTimestampDesc(
            daysAgo, rightNow, SecurityUtils.getCurrentUserLogin());
    BloodPressureByPeriod response = new BloodPressureByPeriod("Last " + days + " Days", readings);
    return new ResponseEntity<>(response, HttpStatus.OK);
}
----
====

I added a new method to support this API in `blood-pressure.service.js`.

[source,javascript]
.src/main/webapp/app/entities/blood-pressure/blood-pressure.service.js
----
function BloodPressure ($resource, DateUtils) {
    var resourceUrl =  'api/blood-pressures/:id';

    return $resource(resourceUrl, {}, {
        'query': { method: 'GET', isArray: true},
        'last30Days': { method: 'GET', isArray: false, url: 'api/bp-by-days/30'},
        ...
    });
}
----

While gathering this data seemed easy enough, the hard part was figuring out what charting library to use to display it.

==== Charts of the last 30 days

I did a https://twitter.com/mraible/status/633738800879898624[bit of research] and decided to use
http://krispo.github.io/angular-nvd3[Angular-nvD3]. I'd heard good things about https://d3js.org/[D3.js] and Angular-nvD3
is built on top of it. To install Angular-nvD3, I used Bower's install command.

----
bower install angular-nvd3 --save
----

Then I ran `gulp inject` to update `index.html` and `karma.conf.js` with references to the new files. I also updated
`app.module.js` to add `nvd3` as a dependency.

[source,javascript]
.src/main/webapp/app/app.module.js
----
angular
    .module('21PointsApp', [
        'ngStorage',
        'tmh.dynamicLocale',
        'pascalprecht.translate',
        'ngResource',
        'ngCookies',
        'ngAria',
        'ngCacheBuster',
        'ngFileUpload',
        'ui.bootstrap',
        'ui.bootstrap.datetimepicker',
        'ui.router',
        'infinite-scroll',
        // jhipster-needle-angularjs-add-module JHipster will add new module here
        'angular-loading-bar',
        'nvd3'
    ])
    .run(run);
----

I modified `home.controller.js` to have the `BloodPressure` service as a dependency and went to work building the
data so Angular-nvD3 could render it. I found that charts required a bit of JSON to configure them, so I created
a service to contain this configuration.

[source,javascript]
.app/components/chart/chart.service.js
----
(function() {
    'use strict';

    angular.module('21PointsApp')
        .factory('Chart', function Chart() {
            return {
                getBpChartConfig: function() {
                    return bpChartConfig;
                }
            }
        });

    var today = new Date();
    var priorDate = new Date().setDate(today.getDate()-30);

    var bpChartConfig = {
        chart: {
            type: "lineChart",
            height: 200,
            margin: {
                top: 20,
                right: 20,
                bottom: 40,
                left: 55
            },
            x: function(d){ return d.x; },
            y: function(d){ return d.y; },
            useInteractiveGuideline: true,
            dispatch: {},
            xAxis: {
                axisLabel: "Dates",
                showMaxMin: false,
                tickFormat: function(d){
                    return d3.time.format("%b %d")(new Date(d));
                }
            },
            xDomain: [priorDate, today],
            yAxis: {
                axisLabel: "",
                axisLabelDistance: 30
            },
            transitionDuration: 250
        },
        title: {
            enable: true
        }
    };
})();

----

In `home.controller.js`, I grabbed the blood pressure readings from the API and morphed them into data that Angular-nvD3
could understand.

[source,javascript]
.src/main/webapp/app/home/home.controller.js
----
BloodPressure.last30Days(function (bpReadings) {
    vm.bpReadings = bpReadings;
    if (bpReadings.readings.length) {
        vm.bpOptions = angular.copy(Chart.getBpChartConfig());
        vm.bpOptions.title.text = bpReadings.period;
        vm.bpOptions.chart.yAxis.axisLabel = "Blood Pressure";
        var systolics, diastolics, upperValues, lowerValues;
        systolics = [];
        diastolics = [];
        upperValues = [];
        lowerValues = [];
        bpReadings.readings.forEach(function (item) {
            systolics.push({
                x: new Date(item.timestamp),
                y: item.systolic
            });
            diastolics.push({
                x: new Date(item.timestamp),
                y: item.diastolic
            });
            upperValues.push(item.systolic);
            lowerValues.push(item.diastolic);
        });
        vm.bpData = [{
            values: systolics,
            key: 'Systolic',
            color: '#673ab7'
        }, {
            values: diastolics,
            key: 'Diastolic',
            color: '#03a9f4'
        }];
        // set y scale to be 10 more than max and min
        vm.bpOptions.chart.yDomain = [Math.min.apply(Math, lowerValues) - 10, Math.max.apply(Math, upperValues) + 10]
    }
});
----

Finally, I used the "`nvd3`" directive in `home.html` to read `vm.bpOptions` and `vm.bpData`, then display a chart.

[source,html]
.src/main/webapp/app/home/home.html
----
<div class="row">
    <div class="col-md-10">
        <span ng-if="vm.bpReadings.readings.length">
            <nvd3 options="vm.bpOptions" data="vm.bpData" class="with-3d-shadow with-transitions"></nvd3>
        </span>
        <span ng-if="!vm.bpReadings.readings.length">
            <div uib-alert type="info">No blood pressure readings found.</div>
        </span>
    </div>
</div>
----

After entering some test data, I was quite pleased with the results.

[[img-homepage-bp-last-30-days]]
.Chart of blood pressure during the last 30 days
image::chapter2/homepage-bp-last-30-days.png[Chart of blood pressure during the last 30 days, 1393, scaledwidth=100%, align=center]

I made similar changes to display weights for the last 30 days as a chart.

=== Lines of code

After finishing the MVP (minimum viable product) of 21-Points Health, I did some quick calculations to see how
many lines of code JHipster had produced. You can see from the graph below that I only had to write 1,529
lines of code. JHipster did the rest for me, generating 92.6% of the code in my project!

[[img-21-points-loc]]
.Project lines of code
image::chapter2/21-points-loc.png[Project lines of code, 1155, scaledwidth=100%, align=center]

To drill down further, I made a graph of the top three languages in the project: Java, JavaScript, and HTML.

[[img-21-points-loc-by-language]]
.Project lines of code by language
image::chapter2/21-points-loc-by-language.png[Project lines of code by language, 1282, scaledwidth=100%, align=center]

The amount of code I had to write in each language was 718 lines of Java, 775 lines of JavaScript, and 304 lines of HTML.

Wahoo! Thanks, JHipster!

.Testing
****
You probably noticed that a lot of the Java code I wrote was for the tests. I felt that these tests were essential to prove that
the business logic I implemented was correct. It's never easy to work with dates but Java 8's Date-Time API greatly simplified
it and Spring Data JPA made it easy to write "`between date`" queries.

I believe TDD (test-driven development) is a great way to write code. However, when developing UIs, I tend to make them
work before writing tests. It's usually a very visual activity and, with the aid of Browsersync, there's rarely a delay before
you see your changes. I like to write unit tests for my Angular controllers and directives using
http://jasmine.github.io/2.5/introduction.html[Jasmine] and I like to write integration tests with
http://www.protractortest.org/#/[Protractor].

I did not write any JavaScript tests for this project because I was in a time crunch and I was able to visually verify that
things worked as I wanted. I plan to write unit and integration tests when I find the time, but didn't think they
were necessary for the MVP.
****

== Deploying to Heroku

JHipster ships with support for deploying to Cloud Foundry, Heroku, Kubernetes, AWS, and Boxfuse. I used Heroku to
deploy my application to the cloud because I'd worked with it before. When you prepare a JHipster application for
production, it's recommended to use the pre-configured "`production`" profile. With Gradle, you can package your
application by specifying this profile when building.

----
gradlew -Pprod bootRepackage
----

The command looks similar when using Maven.

----
mvn -Pprod package
----

The production profile is used to build an optimized JavaScript client. You can invoke this using Gulp by running `gulp build`.
The production profile also configures gzip compression with a servlet filter, cache headers and monitoring via
https://github.com/dropwizard/metrics[Metrics]. If you have a http://graphite.wikidot.com/[Graphite] server configured in
your `application-prod.yaml` file, your application will automatically send metrics data to it.

To upload 21-Points Health, I logged in to my Heroku account. I already had the https://devcenter.heroku.com/articles/heroku-command-line[Heroku CLI]
installed.

TIP: I first deployed to Heroku after integrating the Material Design theme, meaning that I had a basically default JHipster application with no entities.

----
$ heroku login
Enter your Heroku credentials.
Email: matt@raibledesigns.com
Password (typing will be hidden):
Authentication successful.
----

I ran `yo jhipster:heroku` as recommended in the http://jhipster.github.io/heroku/[Deploying to Heroku]
documentation. I tried using the name "`21points`" for my application when prompted.

----
$ yo jhipster:heroku
Heroku configuration is starting
? Name to deploy as: 21points
? On which region do you want to deploy ? us

Using existing Git repository

Installing Heroku CLI deployment plugin

Creating Heroku application and setting up node environment
heroku create 21-points --addons heroku-postgresql
✖ { [Error: Command failed: /bin/sh -c heroku create 21-points --addons heroku-postgresql
Creating 21-points... !
▸    Name must start with a letter and can only contain lowercase letters,
▸    numbers, and dashes.
]
killed: false,
code: 1,
signal: null,
cmd: '/bin/sh -c heroku create 21-points --addons heroku-postgresql' }
----

You can see my first attempt failed for the same reason that creating a local PostgreSQL database failed: it didn't
like that the database name started with a number. I tried again with "`health`", but that failed, too, since a Heroku app
with this name already existed. Finally, I settled on "`health-by-points`" as the application name and everything
succeeded.

----
$ yo jhipster:heroku
Heroku configuration is starting
? Name to deploy as: health-by-points
? On which region do you want to deploy ? us

Using existing Git repository

Installing Heroku CLI deployment plugin

Creating Heroku application and setting up node environment
heroku create health-by-points --addons heroku-postgresql
https://health-by-points.herokuapp.com/ | https://git.heroku.com/health-by-points.git

Creating Heroku deployment files
   create src/main/resources/config/bootstrap-heroku.yml
   create src/main/resources/config/application-heroku.yml
   create Procfile

Building application
...

BUILD SUCCESSFUL

Total time: 50.636 secs

Deploying application

Uploading your application code.
 This may take several minutes depending on your connection speed...
Uploading 21-points-0.0.1-SNAPSHOT.war
----

I was pumped to see that this process worked and that my application was available at http://health-by-points.herokuapp.com.
I quickly changed the default passwords for *admin* and *user* to make things more secure.

[[img-deployed-to-heroku]]
.First deployment to Heroku
image::chapter2/deployed-to-heroku.png[First deployment to Heroku, 1175, scaledwidth=100%, align=center]

Next, I bought the 21-points.com domain from https://domains.google.com[Google Domains]. To configure this domain for
Heroku, I ran `heroku domains:add`.

----
$ heroku domains:add www.21-points.com
Adding www.21-points.com to health-by-points... done
!    Configure your app's DNS provider to point to the DNS Target www.21-points.com
!    For help, see https://devcenter.heroku.com/articles/custom-domains
----

I read the https://devcenter.heroku.com/articles/custom-domains[documentation], then went to work configuring
DNS settings on Google Domains. I configured a subdomain forward of:

----
21-points.com → http://www.21-points.com
----

I also configured a custom resource record with a CNAME to point to health-by-points.herokuapp.com.

.Custom resource record on Google Domains
|===
|Name |Type |TTL |Data

|*
|CNAME
|1h
|health-by-points.herokuapp.com
|===

This was all I needed to get my JHipster application running on Heroku. However, after generating entities and adding
more code to the project, I found some issues. First of all, I learned that after the initial setup, you can redeploy
your application using https://github.com/heroku/heroku-deploy[heroku-deploy]. Use the following command to install
this plugin.

----
heroku plugins:install https://github.com/heroku/heroku-deploy
----

After that, you can package your JHipster project for production and deploy it. Using Gradle, it looks like this.

----
gradlew -Pprod bootRepackage -x test
heroku deploy:jar --jar build/libs/*war --app health-by-points
----

With Maven, the commands look slightly different:

----
mvn install -Pprod -DskipTests
heroku deploy:jar --jar target/*.war
----

I ran the deployment command after generating all my entities and it looked like everything worked just fine.

....
$ heroku deploy:jar --jar build/libs/*war --app health-by-points
Uploading build/libs/21points-0.1-SNAPSHOT.war....
-----> Packaging application...
       - app: health-by-points
       - including: build/libs/21points-0.1-SNAPSHOT.war
-----> Creating build...
       - file: slug.tgz
       - size: 63MB
-----> Uploading build...
       - success
-----> Deploying...
remote:
remote: -----> Fetching custom tar buildpack... done
remote: -----> JVM Common app detected
remote: -----> Installing OpenJDK 1.8... done
remote: -----> Discovering process types
remote:        Procfile declares types -> web
remote:
remote: -----> Compressing... done, 112.5MB
remote: -----> Launching... done, v14
remote:        https://health-by-points.herokuapp.com/ deployed to Heroku
remote:
-----> Done
....

I tailed my log files with `heroku logs --tail` to make sure everything started up okay. I was soon disappointed when
the application didn't start within 60 seconds.

----
Error R10 (Boot timeout) -> Web process failed to bind to $PORT within 60 seconds of launch
----

This is an expected problem with JHipster and Heroku. I created a support ticket at https://help.heroku.com/ and asked
to increase my application's allowed timeout to 120 seconds. Heroku's support team was quick to respond and boosted my timeout within minutes.

TIP: If you need to reset your Postgres database on Heroku, you can do so my logging into http://api.heroku.com.
Click on your application name > Add-Ons > Heroku Postgres :: Gray and select "`Reset Database`" from the gear icon
in the top right corner.

=== Elasticsearch on Heroku

Once my application's timeout was increased, it seemed like everything was working. I tried to register a new user,
and saw the following error message in my logs.

----
2015-08-20T14:37:54.660329+00:00 app[web.1]: Caused by: org.elasticsearch.client.transport.NoNodeAvailableException:
None of the configured nodes are available: []
----

I searched for an Elasticsearch add-on for Heroku and found https://devcenter.heroku.com/articles/bonsai[Bonsai
Elasticsearch]. Its cheapest plan cost $10/month. Since I didn't want to pay for anything right away, I decided
to configure Elasticsearch to use an in-memory store like it did in development. (I later discovered that
https://addons.heroku.com/searchbox[Searchbox Elasticsearch] offers a free plan.) I updated my `application-prod.yml`
file to use Heroku's ephemeral filesystem.

[source,yaml]
.src/main/resources/config/application-prod.yml
----
# Configure prod to use ElasticSearch in-memory.
# http://stackoverflow.com/questions/12416738/how-to-use-herokus-ephemeral-filesystem
data:
    elasticsearch:
        cluster-name:
        cluster-nodes:
        properties:
            path:
              logs: /tmp/elasticsearch/log
              data: /tmp/elasticsearch/data
----

=== Mail on Heroku

After making this change, I repackaged and redeployed. This time, when I tried to register, I received an error when my
`MailService` tried to send me an activation e-mail.

----
2015-08-20T15:11:36.809174+00:00 heroku[web.1]: Process running mem=561M(109.6%)
2015-08-20T15:11:36.809174+00:00 heroku[web.1]: Error R14 (Memory quota exceeded)
2015-08-20T15:11:41.395945+00:00 heroku[router]: at=info method=POST path="/api/register?cacheBuster=1440083497301" host=www.21-points.com ...
2015-08-20T15:11:43.106106+00:00 app[web.1]: [WARN] org.jhipster.health.service.MailService - E-mail could not be sent to
user 'matt@raibledesigns.com', exception is: Mail server connection failed; nested exception is javax.mail.MessagingException:
Connection error (java.net.ConnectException: Connection refused). Failed messages: javax.mail.MessagingException:
Connection error (java.net.ConnectException: Connection refused)
----

TIP: You might notice the "`Memory quota exceeded`" message in the logs. I receive this often when running JHipster applications
under Heroku's https://www.heroku.com/pricing[free and hobby dynos]. My application stays running, though, so I've learned
to ignore it.

I'd used Heroku's https://addons.heroku.com/sendgrid[SendGrid] for e-mail in the past, so I added it to my project.

----
$ heroku addons:create sendgrid
Creating giving-softly-5465... done, (free)
Adding giving-softly-5465 to health-by-points... done
Setting SENDGRID_PASSWORD, SENDGRID_USERNAME and restarting health-by-points... done, v17
Use `heroku addons:docs sendgrid` to view documentation.
----

Then I updated `application-prod.yml` to use the configured `SENDGRID_PASSWORD` and `SENDGRID_USERNAME` environment
variables for mail, as well as to turn on authentication.

[source,yaml]
.src/main/resources/config/application-prod.yml
----
mail:
    host: smtp.sendgrid.net
    port: 587
    username: ${SENDGRID_USERNAME}
    password: ${SENDGRID_PASSWORD}
    protocol: smtp
    tls: false
    auth: true
    from: app@21-points.com
----

After repackaging and redeploying, I used the built-in health-checks feature of my application to verify that everything
was configured correctly.

== Monitoring and analytics

JHipster generates the code necessary for Google Analytics in every application's `src/main/webapp/index.html` file.
I chose not to enable this just yet, but I hope to eventually. I already have a http://www.google.com/analytics/[Google Analytics] account, so it's just a matter of creating a new account for www.21-points.com, copying the
account number, and modifying the following section of `index.html`:

[source,html]
.src/main/webapp/index.html
----
<!-- Google Analytics: uncomment and change UA-XXXXX-X to be your site's ID.
<script>
    (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
    function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
    e=o.createElement(i);r=o.getElementsByTagName(i)[0];
    e.src='//www.google-analytics.com/analytics.js';
    r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
    ga('create','UA-XXXXX-X');ga('send','pageview');
</script>-->
----

I've used http://newrelic.com/[New Relic] to monitor my production applications in the past. There is a free
https://addons.heroku.com/newrelic[New Relic add-on] for Heroku. Heroku's https://devcenter.heroku.com/articles/newrelic[New Relic APM]
describes how to set things up if you're letting Heroku do the build for you (meaning, you deploy with
`git push heroku master`). However, if you're using the heroku-deploy plugin, it's a bit different.

For that, you'll first need to manually download the New Relic Agent, as well as a `newrelic.yml` license file, and put them in the root directory
of your project. Then you can run a command like:

----
heroku deploy:jar --jar build/libs/*war --includes newrelic.jar:newrelic.yml
----

That will include the JAR in the slug. Then you'll need to modify your Procfile to include the `javaagent` argument:

----
web: java -javaagent:newrelic.jar -jar build/libs/*.war
----

== Continuous integration and deployment

After generating entities for this project, I wanted to configure a continuous-integration (CI) server to build/test/deploy
whenever I checked in changes to Git. I chose https://jenkins.io/[Jenkins] for my CI server and used the simplest
configuration possible: I downloaded `jenkins.war` to `/opt/tools/jenkins` on my MacBook Pro. I started it with
the following command.

----
java -jar jenkins.war --httpPort=9000
----

JHipster has good documentation on https://jhipster.github.io/setting-up-ci-jenkins2/[setting up Continuous Integration on Jenkins 2] and
http://jhipster.github.io/heroku/[deploying to Heroku]. I followed JHipster's Jenkins 2 documentation and opted for the global
NodeJS installation.

****
.Travis CI
JHipster ships with a `.travis.yml` file that allows you to run your application's tests on https://travis-ci.org[Travis CI].
You can modify it to run Protractor tests using something like the following:

```
language: java
jdk:
  - oraclejdk8
sudo: false
cache:
  directories:
    - node
    - node_modules
    - $HOME/.gradle
env:
  - NODE_VERSION=4.4.7
before_install:
  - nvm install $NODE_VERSION
  - npm install -g npm
  - npm install -g bower gulp-cli
  - node -v
  - npm -v
  - bower -v
  - gulp -v
  - java -version
install: npm install
script:
  - ./gradlew clean
  - ./gradlew test
  - gulp test
  - ./gradlew bootRepackage -Pprod -x test
notifications:
  webhooks:
    on_success: change  # options: [always|never|change] default: always
    on_failure: always  # options: [always|never|change] default: always
    on_start: false     # default: false

os:
  - linux
services:
  - docker
language: java
node_js:
  - "4.2.1"
jdk:
  - oraclejdk8
before_install:
  - sudo /etc/init.d/postgresql stop
install:
  - java -version
  - ./gradlew --version
  - npm install -g bower
  - npm install -g grunt-cli
  - npm install
  - ./gradlew assemble
script:
  - ./gradlew test
  - gulp test
  - docker-compose up -d
  - sleep 20s
  - export DISPLAY=:99.0
  - sh -e /etc/init.d/xvfb start
  - ./gradlew bootRun &
  - bootPid=$!
  - sleep 120s
  - gulp itest
  - ./gradlew bootRepackage -Pprod -x test
```
****

I created a new job called "21-points" with a Pipeline script from SCM. By default, a JHipster-generated project
contains a `Jenkinsfile`. I configured a "Poll SCM" build trigger with a schedule of `H/5 * * * *`. After saving the job,
I confirmed it ran successfully.

[[jenkins-job1]]
.Jenkins build #1
image::chapter2/jenkins-job-1.png[First run of 21-points pipeline, 1124, scaledwidth=100%, align=center]

I modified this file to add running Protractor tests and deploying to Heroku. I checked in my changes to trigger
another build.

[source]
.Jenkinsfile
----
node {
    // uncomment these 2 lines and edit the name 'node-4.4.7' according to what you choose in configuration
    // def nodeHome = tool name: 'node-4.4.7', type: 'jenkins.plugins.nodejs.tools.NodeJSInstallation'
    // env.PATH = "${nodeHome}/bin:${env.PATH}"

    stage('check tools') {
        sh "node -v"
        sh "npm -v"
        sh "bower -v"
        sh "gulp -v"
    }

    stage('checkout') {
        checkout scm
    }

    stage('npm install') {
        sh "npm install"
    }

    stage('clean') {
        sh "./gradlew clean"
    }

    stage('backend tests') {
        sh "./gradlew test"
    }

    stage('frontend tests') {
        sh "gulp test"
    }

    stage('protractor tests') {
        sh '''./gradlew &
        bootPid=$!
        sleep 45s
        gulp itest
        kill $bootPid
        '''
    }

    stage('packaging') {
        sh "./gradlew bootRepackage -Pprod -x test"
    }

    stage('deploying') {
        sh "heroku deploy:jar --jar build/libs/*.war --app health-by-points"
    }
}
----

After making these changes, I found out that my Protractor tests were failing. I tried running them using `gulp itest` and
found that Firefox was not loading the application. Since I'd recently experienced Firefox and Protractor issues on another
project, I changed to use Chrome. To to this, I modified `protractor.conf.js` and fixed the path to the Chrome driver.

[source,diff]
.src/test/javascript/protractor.conf.js
----
@@ -5,7 +5,7 @@ var prefix = 'src/test/javascript/'.replace(/[^/]+/g,'..');

 exports.config = {
     seleniumServerJar: prefix + 'node_modules/protractor/node_modules/webdriver-manager/selenium/selenium-server-standalone-2.53.1.jar',
-    chromeDriver: prefix + 'node_modules/protractor/selenium/chromedriver',
+    chromeDriver: prefix + 'node_modules/protractor/node_modules/webdriver-manager/selenium/chromedriver_2.22',
     allScriptsTimeout: 20000,

     suites: {
@@ -15,7 +15,7 @@ exports.config = {
     },

     capabilities: {
-        'browserName': 'firefox',
+        'browserName': 'chrome',
         'phantomjs.binary.path': require('phantomjs-prebuilt').path,
         'phantomjs.ghostdriver.cli.args': ['--loglevel=DEBUG']
     },
----

This got me a bit further, but tests still failed. I banged my head against the wall for a few hours before I figured out
the problem: `translate` is a reserved attribute name in HTML5 and Chrome (and Safari) return a boolean for this value if
its present. Not only that, but Protractor's `element.getAttribute()` returns a promise rather than a value.

As part of this debugging exercise, I also discovered that Firefox 48 does not work with Protractor. The most recent
version I found that works is Firefox 46. Also, Firefox 46 (and below) don't require you to resolve the promise
returned from Protractor's `element.getAttribute()`. However, since both Safari and Chrome require this change (and
it works in Firefox), I made the following changes:

1. Changed all `translate` attributes in the project's `*.html` files to `data-translate`.
2. Changed all Protractor tests (in `src/test/javascript/e2e`) to process the promise and validate the value afterward.

[source,javascript]
----
element.all(by.css('h1')).first().getAttribute('data-translate').then(function (value) {
    expect(value).toMatch(/home.title/);
});
----

After making these changes, https://github.com/jhipster/generator-jhipster/pull/4076[created a pull request] to
fix this in JHipster's main generator. Then I spent hours trying to get all the Protractor tests passing. I discovered
that logout wasn't happening consistently for Chrome and Safari, causing some tests to fail. Finally, I switched back to Firefox
and was able to get consistent results.

[source,diff]
.src/test/javascript/protractor.conf.js
----
@@ -15,7 +15,7 @@ exports.config = {
     },

     capabilities: {
+        'browserName': 'firefox',
-        'browserName': 'chrome',
         'phantomjs.binary.path': require('phantomjs-prebuilt').path,
         'phantomjs.ghostdriver.cli.args': ['--loglevel=DEBUG']
     },
----

I checked in my changes, restarting Jenkins, and verified that all stages in my pipeline passed.

[[jenkins-job-success]]
.Jenkins success!
image::chapter2/jenkins-job-success.png[Jenkins success!, 1461, scaledwidth=100%, align=center]

When working on this project, I'd start Jenkins and have it running while I checked in code. I did not install it on a
server and leave it running continuously. My reason was simple: I was only coding in bursts and didn't need to waste
computing cycles or want to pay for a cloud instance to run it.

== Source Code

After getting this application into a "good enough" state, I moved it from Bitbucket to GitHub and made it available
as an open source project. You can find the source code for 21-Points Health at https://github.com/mraible/21-points.

== Upgrading 21-Points

After I finished developing the MVP of 21-Points Health with JHipster 3.7.0, I wanted to upgrade it to the latest release.
Rather than doing it manually like I did previously, I tried the using the https://jhipster.github.io/upgrading-an-application/[upgrade sub-generator].
I'd tried it before and it didn't work. Thanks to a https://github.com/jhipster/generator-jhipster/issues/4239[recent bug fix],
it worked like a charm this time.

[[jhipster-upgrade-start]]
.JHipster Upgrade Start
image::chapter2/jhipster-upgrade-start.png[Running the jhipster:upgrade sub-generator, 1026, scaledwidth=100%, align=center]

[[jhipster-upgrade-finish]]
.JHipster Upgrade Result
image::chapter2/jhipster-upgrade-finish.png[Upgrade Result, 1026, scaledwidth=100%, align=center]

After the command finished (in just over two minutes), I fixed the conflicts and checked in my changes. If you're reading
this and notice that 21-Points is using a version > 3.8.0, it's likely because I used this handy sub-generator again.

== Summary

This section showed you how I created a health-tracking web application with JHipster. It walked you through upgrading to the
latest release of JHipster and how to generate code with `yo jhipster:entity`. You learned how to do test-first development
when writing new APIs and how Spring Data JPA makes it easy to add custom queries. You also saw how to reuse existing
dialogs on different pages, how to add methods to client services, and how to manipulate data to display pretty charts.

After modifying the application to look like my UI mockups, I showed you how to deploy to Heroku and some
common issues I encountered along the way. Finally, you learned how to use Jenkins to build, test, and deploy a
Gradle-based JHipster project. I highly recommend doing something similar shortly after you've created your project
and verified that it passes all tests.

In the next chapter, I'll explain JHipster's UI components in more detail. AngularJS, Bootstrap, Gulp, Sass, WebSockets,
and Browsersync are all packed in a JHipster application, so it's useful to dive in and learn a bit more about these technologies.
