When I started writing this book, I had a few different ideas for a sample application. My first idea involved creating
a photo gallery to showcase the 1996 VW Bus I've been working on for over 10 years. The project is almost finished and
I wanted a website to show how things have progressed through the years. I also thought about creating a blog application.
As part of http://raibledesigns.com/rd/entry/getting_hip_with_jhipster_at[my first presentation on JHipster] (at Denver's
Java User Group), I created a blog application that I live-coded to the audience. After that presentation, I spent
several hours polishing the application and started http://www.jhipster-book.com[www.jhipster-book.com] with it.

After thinking about the VW Bus Gallery and developing the blog application, I thought to myself "is this hip enough?"
Shouldn't a book about becoming a Java Hipster show how to build a hip application?

I wrote to Julien Dubois, founder of JHipster, and Dennis Sharpe, the technical editor for this book and asked them
their thoughts. We went back and forth on a few ideas: a gitter.im clone, a job board for Java hipsters, a shopping cart
app. Then it hit me, there was an I'd been wanting to develop for a while.

It's basically an app that you can use to monitor their health. In late September through mid-October 2014, I'd done a
"sugar detox" where I stopped eating sugar, started exercising regularly and stopped drinking alcohol. I'd had high blood
pressure for over 10 years and was on blood pressure medication at the time. During the first week of the detox, I ran
out of blood pressure medication. Since getting a new prescription required a doctors visit, I decided I'd wait until
after the detox to do so. After three weeks, not only did I lose 15 pounds, but my blood pressure was at normal levels!

Before I started the detox, I came up with a 21-point system to see how healthy I was being each week. Its rules were
simple: you can earn up to three points per day, for the following reasons:

1. If you eat healthy, you get a point. Otherwise, zero.
2. If you exercise, you get a point.
3. If you don't drink alcohol, you get a point.

I was surprised to find I got eight points the first week I used this system. During the detox, I got 16 points the
first week, 20 the second and 21 the third. Before the detox, I thought eating healthy meant eating anything but
fast food. After the detox, I realized that _eating healthy_ meant eating no sugar for me. I'm also a big craft
beer lover, so I've modified the alcohol rule to allow two healthier alcohol drinks per day (like a greyhound or
red wine).

My point goal per week is 15. I find that if I get above it, I'll likely lose weight and have good blood pressure. If I
get below 15, I risk getting sick. I've been tracking my health like this since September 2014. I've lost 30 pounds and
my blood pressure has returned to normal levels. I haven't had good blood pressure since my early 20s, so this has been
a life-changer for me.

I thought writing a "21-Point Health" application this would be hip because tracking your health is becoming more
important. With wearables that can track it for you, I might be able to create some APIs or hooks that can auto-record
points for a day. Imagine hooking into dailymile.com (where I track my exercise) or Untappd (where I sometimes checkin
the beers I drink). Or even displaying other activities for a day (e.g. showing your blood pressure score that you keep on
bettir.com).

I thought it'd fit nicely with JHipster and Spring Boot from a monitoring standpoint. Spring Boot has lots of health
monitors for your app, now you can use this JHipster app to monitor your health!

This chapter has six different sections:

. Creating the application
. Building the UI and business logic
. Application Improvements
. Testing
. Deployment
. Monitoring and Analytics

=== Creating the Application

I started using the http://jhipster.github.io/installation.html[Installing JHipster] instructions. I'm a Java Developer,
so I already had Java 8 installed, as well as Maven and Git. I installed Node.js from https://nodejs.org/[nodejs.org], then
ran the following commands to install http://yeoman.io/[Yeoman] and http://bower.io/[Bower].

[source]
----
npm install -g yo
npm install -g bower
----

I also installed Grunt and JHipster.

[source]
----
npm install -g grunt-cli
npm install -g generator-jhipster
----

Then I proceeded to build my application. Unlike many application generators in Javaland, Yeoman expects you to be
in the directory you want to create your project in, rather than creating the directory for you. So I created a `21-points`
directory and typed in the following command to invoke JHipster.

[source]
----
yo jhipster
----

After running this command, I was prompted to answer questions about how I wanted my application to be generated. You can
see the choices I made in <<img-generating-21points>>.

[[img-generating-21points]]
.Generating the application
image::images/chapter2/generating-21points.png[Generating the application, 1416, scaledwidth="100%"]

You can see that I chose PostgreSQL as my development and production database. The reason I did this is because using a
non-embedded database (like H2) offers some important benefits.

* Your data is retained when restarting the application.
* Your application starts a bit faster.
* You can use Liquibase to generate a database changelog.

http://www.liquibase.org/[Liquibase] is described as source control for your database. It will help create new fields as
you add them to your entities. It will also refactoring your database, for example creating tables and dropping columns.
It also has the ability to undo changes to your database, either automatically or with custom SQL.

After answering all the questions, JHipster created a whole bunch of files (272 in this case), then ran `npm install`
followed by `bower install`. To prove everything was good-to-go, I ran the unit tests using `grunt test`.

Next, I installed http://postgresapp.com/[Postgres.app] and tried creating a local PostgreSQL database. You can see in
<<img-create-local-db>> that PostgreSQL didn't like the numbers that started my database name.

*[red]#Question: Would this be better as a code listing? Then people could copy and paste.#*

[[img-create-local-db]]
.Creating local database
image::images/chapter2/creating-local-db.png[Creating local database, 1686, scaledwidth="100%"]

I chose the name _health_ instead and updated `src/main/resources/config/application-dev.yml` to use this name and the
specified credentials.

[source,diff]
----
     datasource:
         dataSourceClassName: org.postgresql.ds.PGSimpleDataSource
-        url:
-        databaseName: 21points
-        serverName: localhost
-        username: 21points
-        password:
+        url: jdbc:postgresql://localhost/health
+        username: health
+        password: health
----

==== Adding Source Control

One of the first things I like to do when creating a new project is to add it to a Version Control System (VCS). In this
particular case, I chose Git and Bitbucket. The following commands show how I initialized Git, committed the project,
added a reference to the remote Bitbucket repository, then pushed everything.

[source]
----
$ git init
Initialized empty Git repository in /Users/mraible/dev/21-points/.git/

$ git add -A

$ git commit -m "Initial checkin of 21-points application"
[master (root-commit) c20f856] Initial checkin of 21-points application
 274 files changed, 13179 insertions(+)
 ...

$ git push origin master
Counting objects: 382, done.
Delta compression using up to 8 threads.
Compressing objects: 100% (353/353), done.
Writing objects: 100% (382/382), 242.01 KiB | 0 bytes/s, done.
Total 382 (delta 55), reused 0 (delta 0)
To git@bitbucket.org:mraible/21-points.git
 * [new branch]      master -> master
----

This section showed you how I created a new application with JHipster and checked it into source control. If you're
creating an application following similar steps, I believe there's two common approaches for continuing. The first
involves developing the application, then testing and deploying. The second option is to setup continuous integration,
deploy, then begin development and testing. In a team development environment, I recommend following the second option.
However, since you're likely reading this as an individual, I'll follow the first approach and get right to coding.
If you're interested in setting up continuous integration with Jenkins, please see
http://www.jhipster-book.com/#!/news/entry/building-and-deploying-a-jhipster-app-with-jenkins[Building and Deploying a JHipster App with Jenkins].

=== Building the UI and Business Logic

I wanted 21 Points to be a bit more hip than a stock JHipster application. Bootstrap was all the rage a couple years ago,
but now Google's https://www.google.com/design/[Material Design] is growing in popularity. I searched and found a
https://fezvrasta.github.io/bootstrap-material-design/[Material Design for Bootstrap] theme. To install it, I executed
the following command:

[source]
----
bower install bootstrap-material-design --save
----

After this completed, I ran `grunt wiredep` to add the new CSS and JavaScript dependencies to `src/main/webapp/index.html`.
The https://github.com/taptapship/wiredep[wiredep] task updates files that refer to Bower dependencies for you. In this case,
`src/main/webapp/index.html` and `src/test/javascript/karma.conf.js`.

Then I followed the theme's Getting Started guide and added the following initialization code to the bottom of the page.

[source,html]
----
<script>
    $.material.init()
</script>
----

Finally, I ran `./gradlew bootRun` and confirmed the new theme was being used.

[[img-material-design-theme]]
.Material Design for Bootstrap Theme
image::images/chapter2/material-design-theme.png[Material Design for Bootstrap, 2492, scaledwidth="100%"]

Before creating the entities and associated database tables for this application, I decided to upgrade JHipster to
the latest release. You can see that I created this application with JHipster 2.16.0. The latest release is now
2.19.0, so I updated my version with the following command.

----
npm update -g generator-jhipster
----

This installs the latest version of JHipster, but does nothing to upgrade my project. I had to run the following
command to update the project.

----
yo jhipster
----

This notified me that it was deleting a number of files, and there were some conflicts in my files.footnote:[If you
don't see conflicts when upgrading, it's possible you never installed JHipster on the machine you're using. I found
this when switching machines. Check `package.json` to ensure it has the new version number. If it does not, run \
`npm install -g generator-jhipster`.]

----
This is an existing project, using the configuration from your .yo-rc.json file
to re-generate the project...

Remove the file - src/test/javascript/spec/app/account/health/healthControllerSpec.js
Remove the file - src/test/javascript/spec/app/account/login/loginControllerSpec.js
Remove the file - src/test/javascript/spec/app/account/password/passwordControllerSpec.js
Remove the file - src/test/javascript/spec/app/account/password/passwordDirectiveSpec.js
Remove the file - src/test/javascript/spec/app/account/sessions/sessionsControllerSpec.js
Remove the file - src/test/javascript/spec/app/account/settings/settingsControllerSpec.js
Remove the file - src/test/javascript/spec/components/auth/authServicesSpec.js
 conflict bower.json
? Overwrite bower.json? (Ynaxdh)
----

I answered "Y" to all the conflict questions. Because I had the files in source control, I was able to diff the changes
after they were made and decide if I wanted them or not. Most changes were welcome, but I wanted to keep my theme changes,
so I had to add the following back into `bower.json` and run `bower install` again.

[source,javascript]
----
"bootstrap-material-design": "~0.3.0"
----

I still needed to manually restore the call to initialize the Material Design theme at the bottom of `index.html`.

[source,html]
----
<script>
    $.material.init()
</script>
----

I ran `grunt serve` to verify everything looked good, then committed my updated project to Git.

NOTE: After integrating the Material Design theme, I deployed to Heroku for the first time. This is covered in the
<<Continuous Integration and Deployment>> section of this chapter.

==== Generating Entities

For each entity you want to create, you will need:

* A database table
* A Liquibase change set
* A JPA Entity class
* A Spring Data JPA Respository interface
* A Spring MVC Rest Controller
* An AngularJS router, controller and service
* An HTML page

In addition, you should have integration tests to verify everything works, and performance tests to verify it's fast. In
an ideal world, you'd also have unit tests and integration tests for your Angular code.

The good news is JHipster can generate all of this code for you, including integration tests and performance tests. At the
time of this writing, it does not support generating UI tests.footnote:[See https://github.com/jhipster/generator-jhipster/issues/897[issue #897]
for more information on why UI testing is not supported.]
In addition, if you have entities with relationships, it will generate the necessary schema to support them (with foreign keys)
and the JavaScript and HTML code to manage them. Validation can also be setup to require certain fields, as well as control their length.

JHipster supports two methods of code generation. The first is using its
https://jhipster.github.io/creating_an_entity.html[entity sub-generator]. The entity sub-generator is a command-line tool
that prompts you with questions and you provide the answers. https://jhipster.github.io/jhipster_uml.html[JHipster UML]
is an alternative for those that like visual tools. UML Editors supported include https://www.modeliosoft.com/[Modelio],
http://www.umldesigner.org/[UML Designer], https://www.genmymodel.com/[GenMyModel] and
http://www.visual-paradigm.com/[Visual Paradigm]. Because I believe the entity sub-generation is simpler to use, I chose
it for this project.

The <<img-entity-diagram>> shows the data model for this project. A user has a goal, which is tied to metrics
and a daily log of activities. The activities could be further abstracted so they're not explicitly exercise, meals and
alcohol, but it's important to start somewhere, not get it right the first time.

[[img-entity-diagram]]
.21-Point Health Entity Diagram
image::images/chapter2/entity-diagram.png[21-Point Health Entity Diagram, 684, scaledwidth="75%", align="center"]

The most important thing to remember when generating entities with JHipster is you must generate the entity that
owns the relationship first. In this application, the `Metric` entity is owned by `Goal` and `Entry`, so we'll generate
that one first. The relationships could be simplified to only track metrics for the entry, but then it'd be difficult
to relate that back to the goal and display progress. <<img-entity-diagram-simple>> is a simplified version, without
a relationship of metrics to goals. For more information, see
https://jhipster.github.io/managing_relationships.html[Managing Relationships with JHipster].

[[img-entity-diagram-simple]]
.Simple Entity Diagram
image::images/chapter2/entity-diagram-simple.png[Simple Entity Diagram, 684, scaledwidth="75%", align="center"]

I started by generating a `Goal` entity, with a many-to-one relationship with `User`. Below are the questions and
answers I used to generate this entity.

....
$ yo jhipster:entity Goal
The entity Goal is being created.
Generating field #1
? Do you want to add a field to your entity? Yes
? What is the name of your field? name
? What is the type of your field? String
? Do you want to add validation rules to your field? Yes
? Which validation rules do you want to add? Required, Minimum length
? What is the minimum length of your field? 10
=================Goal=================
name (String) required minlength='10'
Generating field #2
? Do you want to add a field to your entity? Yes
? What is the name of your field? description
? What is the type of your field? String
? Do you want to add validation rules to your field? No
=================Goal=================
name (String) required minlength='10'
description (String)
Generating field #3
? Do you want to add a field to your entity? No
=================Goal=================
name (String) required minlength='10'
description (String)
Generating relationships with other entities
? Do you want to add a relationship to another entity? Yes
? What is the name of the other entity? user
? What is the name of the relationship? user
? What is the type of the relationship? many-to-one
? When you display this relationship with AngularJS, which field from 'user' do you want to use? id
===========Goal==============
name (String)
description (String)
-------------------
user - user (many-to-one)
Generating relationships with other entities
? Do you want to add a relationship to another entity? No
===========Goal==============
name (String)
description (String)
-------------------
user - user (many-to-one)
? Do you want pagination on your entity? No
....

:icons: font
NOTE: I didn't add any pagination because I've been tracking my goals quarterly. I may add it at a later
date after I've been using this app for a while.

After answering the last question, the files to create/read/update/delete this entity were generated.

----
Everything is configured, generating the entity...
   create .jhipster/Goal.json
   create src/main/java/org/jhipster/health/domain/Goal.java
   create src/main/java/org/jhipster/health/repository/GoalRepository.java
   create src/main/java/org/jhipster/health/repository/search/GoalSearchRepository.java
   create src/main/java/org/jhipster/health/web/rest/GoalResource.java
   create src/main/resources/config/liquibase/changelog/20150811180009_added_entity_Goal.xml
   create src/main/webapp/scripts/app/entities/goal/goals.html
   create src/main/webapp/scripts/app/entities/goal/goal-detail.html
   create src/main/webapp/scripts/app/entities/goal/goal.js
   create src/main/webapp/scripts/app/entities/goal/goal.controller.js
   create src/main/webapp/scripts/app/entities/goal/goal-detail.controller.js
   create src/main/webapp/scripts/components/entities/goal/goal.service.js
   create src/main/webapp/scripts/components/entities/goal/goal.search.service.js
   create src/test/java/org/jhipster/health/web/rest/GoalResourceTest.java
   create src/test/gatling/simulations/GoalGatlingTest.scala
   create src/main/webapp/i18n/en/goal.json
   create src/main/webapp/i18n/fr/goal.json
----

Next, I proceeded to generate the `Metric` entity, with a many-to-many relationship to `Entry`.

:icons: font
NOTE: When trying to use `value`, JHipster warned me this was a reserved word in PostgreSQL, so I used `amount` instead.

....
$ yo jhipster:entity Metric
The entity Metric is being created.
Generating field #1
? Do you want to add a field to your entity? Yes
? What is the name of your field? name
? What is the type of your field? String
? Do you want to add validation rules to your field? Yes
? Which validation rules do you want to add? Required, Minimum length
? What is the minimum length of your field? 2
=================Metric=================
name (String) required minlength='2'
Generating field #2
? Do you want to add a field to your entity? Yes
? What is the name of your field? amount
? What is the type of your field? String
? Do you want to add validation rules to your field? Yes
? Which validation rules do you want to add? Required
=================Metric=================
name (String) required minlength='2'
amount (String) required
Generating field #3
? Do you want to add a field to your entity? No
=================Metric=================
name (String) required minlength='2'
amount (String) required
Generating relationships with other entities
? Do you want to add a relationship to another entity? Yes
? What is the name of the other entity? entry
? What is the name of the relationship? entry
? What is the type of the relationship? many-to-many
? Is this entity the owner of the relationship? No
===========Metric==============
name (String)
amount (String)
-------------------
entry - entry (many-to-many)
Generating relationships with other entities
? Do you want to add a relationship to another entity? Yes
? What is the name of the other entity? goal
? What is the name of the relationship? goal
? What is the type of the relationship? many-to-many
? Is this entity the owner of the relationship? No
===========Metric==============
name (String)
amount (String)
-------------------
entry - entry (many-to-many)
goal - goal (many-to-many)
Generating relationships with other entities
? Do you want to add a relationship to another entity? No
===========Metric==============
name (String)
amount (String)
-------------------
entry - entry (many-to-many)
goal - goal (many-to-many)
? Do you want pagination on your entity? Yes, with pagination links
....

Finally, I created the `Entry`, with a many-to-one relationship to `Goal` and `Metric`. Rather than showing you all
the questions and answers, I'll explain it in simple terms. I made the `date` a `LocalDate` that's required, the individual
point fields as Integers, and `notes` a String that's not required. JHipster showed me the following output before generating
everything.

....
===========Entry==============
date (LocalDate)
exercise (Integer)
meals (Integer)
alcohol (Integer)
notes (String)
-------------------
goal - goal (many-to-one)
metric - metric (many-to-many)
? Do you want pagination on your entity? Yes, with infinite scroll
....

To ensure that everything was generated correctly, I ran `./gradlew test`. I received numerous failures, many of them looking
similar to the following.

----
org.jhipster.health.web.rest.UserResourceTest > testGetExistingUser FAILED
    java.lang.IllegalStateException
        Caused by: org.springframework.beans.factory.BeanCreationException
            Caused by: javax.persistence.PersistenceException
                Caused by: org.hibernate.AnnotationException
----

I opened `build/reports/tests/index.html` to investigate further and found the following error:

----
Caused by: org.hibernate.AnnotationException: mappedBy reference an unknown target entity property:
  org.jhipster.health.domain.Goal.metrics in org.jhipster.health.domain.Metric.goals
----

I determined this was caused by generating the `Goal` entity without the relationship to `Metric`. So I added
the following Java code to `Goal.java` and ran `./gradlew liquibaseDiffChangelog`.

[source,java]
----
@ManyToMany
@Cache(usage = CacheConcurrencyStrategy.NONSTRICT_READ_WRITE)
@JoinTable(name = "GOAL_METRIC",
    joinColumns = @JoinColumn(name="goals_id", referencedColumnName="ID"),
    inverseJoinColumns = @JoinColumn(name="metrics_id", referencedColumnName="ID"))
private Set<Metric> metrics = new HashSet<>();

public Set<Metric> getMetrics() {
    return metrics;
}

public void setMetrics(Set<Metric> metrics) {
    this.metrics = metrics;
}
----

I had to update `liquibase.gradle` to use the same datasource settings I had in `application-dev.yaml` before this
command worked. After Liquibase completed successfully, I added the generated file to
`src/main/resources/config/liquibase/master.xml`.

[source,xml]
----
<include file="classpath:config/liquibase/changelog/20150811124815_changelog.xml" relativeToChangelogFile="false"/>
----

I then ran `./gradlew test` again. This time, they failed with the following reason:

----
liquibase.exception.DatabaseException: org.h2.jdbc.JdbcSQLException: Table "ENTRY" already exists
----

At this moment, I realized that Liquibase was diffing against my "dev" database, while my tests where hitting my "test" (H2)
database. When I ran Liquibase's diff command, it was looking at my "dev" database, where no tables had been created yet.
To solve this, I removed the changelog reference in `master.xml`, commented out the newly added code in `Goal.java`, and
ran `./gradlew bootRun` to generate the initial tables in my "dev" database. Of course, this failed with the same
`mappedBy reference` error, but my schema did get created and I ran `./gradlew liquibaseDiffChangelog` again. After adding
the generated file to `master.xml`, I was pleased to see my tests passed.

----
BUILD SUCCESSFUL

Total time: 51.422 secs
----

I ran `grunt test` to ensure my UI tests were good to go, then fired up the app and tried everything out. The biggest
issue I noticed was that when you created a `Goal`, it showed the ids of the users instead of their name.

[[img-create-goal-user-id]]
.Create Goal with User Id
image::images/chapter2/create-goal-user-id.png[Create Goal with User Id, 800, scaledwidth="66%", align="center"]

Since the id doesn't provide much information, I changed this to display the user's username instead. In JHipster's
`User.java`, this field is called `login`. To make this change, I modified `.jhipster/Goal.json` and changed its
`otherEntityField` from having a value of `id` to `login`.

[source,json]
----
"relationships": [
    {
        "relationshipId": 1,
        "relationshipName": "user",
        "relationshipNameCapitalized": "User",
        "relationshipFieldName": "user",
        "otherEntityName": "user",
        "relationshipType": "many-to-one",
        "otherEntityNameCapitalized": "User",
        "otherEntityField": "login"
    }
]
----

After making this change, I ran `yo jhipster:entity goal` to regenerate `Goal.java` and its associated UI. Since I'd
modified `Goal.java`, when prompted to overwrite this file, I answered "No".

----
 conflict src/main/java/org/jhipster/health/domain/Goal.java
? Overwrite src/main/java/org/jhipster/health/domain/Goal.java? do not overwrite
     skip src/main/java/org/jhipster/health/domain/Goal.java
----

After restarting everything, I was pleased to see the "user" dropdown contained the `login` field instead of id.

[[img-create-goal-user-login]]
.Create Goal with User Login
image::images/chapter2/create-goal-user-login.png[Create Goal with User Login, 800, scaledwidth="66%", align="center"]

After making this change and regenerating everything, I realized there was an easier way. In `goal-dialog.html`, the
following code existed to display the dropdown of users.

[source,html]
----
<select class="form-control" id="field_user" name="user" ng-model="goal.user.id" ng-options="user.id as user.id for user in users">
----

To modify it to display `user.login` instead, I simply needed to change `ng-options` and its _as_ expression to the following.

[source,html]
----
<select class="form-control" id="field_user" name="user" ng-model="goal.user.id" ng-options="user.id as user.login for user in users">
----

At this point, I added all the generated files to Git, committed and pushed. I noticed that 54 files had been generated
by JHipster. What a time saver!

*[red]#Question: I like how this section shows the evolution of designing/architecting an application. Would it be
better for the reader if there were no mistakes and the design was correct at the beginning? I could turn the first
part of this section into a blog post if you think so.#*

Next, I started to play around with my newly created app to see if it had the functionality I wanted. I was hoping to
easily enter daily entries about whether I'd exercised, ate healthy meals or consumed beer. I also wanted to record
my weight and blood pressure metrics when I measured them. When I started using the UI I'd just created, it seemed
like it _might_ be able to accomplish these goals, but also seemed somewhat cumbersome. That's when I decided to create
a UI mockup with the main screen and its ancillary screens for data entry. I used
https://www.omnigroup.com/omnigraffle[OmniGraffle] and a
https://viget.com/inspire/twitter-bootstrap-3.0-stencils-for-omnigraffle[Bootstrap stencil] to create a
<<img-ui-mockup>>.

[[img-ui-mockup]]
.UI Mockup
image::images/chapter2/ui-mockup.png[Simple Entity Diagram, 846, scaledwidth="75%", align="center"]

==== Starting over with a Straightforward Design

After figuring out how I wanted the UI to look, I realized my data model could be simplified. Before, it was quite generic
and could handle a number of metrics. In my new design, I realized I didn't need to track high-level goals (e.g. lose
five pounds in Q4 2015). I was more concerned with tracking weekly goals and _21 Points_ is all about how many points you
get in a week. I was grateful that JHipster allowed me to quickly see the flaws in my design, then simplify. I created
<<img-entity-diagram-simpler>> as my new data model.

[[img-entity-diagram-simpler]]
.21-Point Health Entity Diagram - Simplified
image::images/chapter2/entity-diagram-simpler.png[21-Point Health Entity Diagram - Simplified, 684, scaledwidth="100%", align="center"]

JHipster created 54 files when generating the previous data model, REST controllers and UI. Rather than hunting down all
these files and deleting them, I reverted to the last commit before them in Git.footnote:[If this doesn't work for you,
see http://stackoverflow.com/a/28921195/65681[this Stack Overflow answer] for a list of what files to delete.]
This is the beauty of using a version control system.

----
$ git reset --hard 8ad48eb
HEAD is now at 8ad48eb Upgraded to JHipster 2.19.0.
----

I also dropped and re-created my local PostgreSQL database.

----
mraible=# drop database health;
DROP DATABASE
mraible=# create database health;
CREATE DATABASE
mraible=# grant all privileges on database health to health;
GRANT
----

Then I ran `yo jhipster:entity points`. I added the appropriate fields, their validation rules and specified a many-to-one
relationship with `User`. Below is the final output from my answers.

....
===========Points==============
date (LocalDate)
exercise (Integer)
meals (Integer)
alcohol (Integer)
notes (String)
-------------------
user - user (many-to-one)
? Do you want to use a Data Transfer Object (DTO)? No, use the entity directly
? Do you want pagination on your entity? Yes, with infinite scroll
Everything is configured, generating the entity...
   create .jhipster/Points.json
   create src/main/java/org/jhipster/health/domain/Points.java
   create src/main/java/org/jhipster/health/repository/PointsRepository.java
   create src/main/java/org/jhipster/health/repository/search/PointsSearchRepository.java
   create src/main/java/org/jhipster/health/web/rest/PointsResource.java
   create src/main/resources/config/liquibase/changelog/20150818154309_added_entity_Points.xml
   create src/main/webapp/scripts/app/entities/points/pointss.html
   create src/main/webapp/scripts/app/entities/points/points-detail.html
   create src/main/webapp/scripts/app/entities/points/points-dialog.html
   create src/main/webapp/scripts/app/entities/points/points.js
   create src/main/webapp/scripts/app/entities/points/points.controller.js
   create src/main/webapp/scripts/app/entities/points/points-dialog.controller.js
   create src/main/webapp/scripts/app/entities/points/points-detail.controller.js
   create src/main/webapp/scripts/components/entities/points/points.service.js
   create src/main/webapp/scripts/components/entities/points/points.search.service.js
   create src/test/java/org/jhipster/health/web/rest/PointsResourceTest.java
   create src/test/gatling/simulations/PointsGatlingTest.scala
   create src/main/webapp/i18n/en/points.json
   create src/main/webapp/i18n/fr/points.json
....

I had similar answers for the `Weight` and `BloodPressure` entities. For `Settings`, I created a one-to-one relationship
with `User`. I learned that _settings_ is a reserved keywork, so used _preferences_ instead.

----
$ yo jhipster:entity settings
The entity name cannot contain a JHipster reserved keyword
----

To ensure people used 21 Point Health effectively, I made the minimum weekly goal 10 points and set a max of 21. I also
made the `weightUnits` property an enum.

----
=================Preferences=================
weekly_goal (Integer) required min='10' max='21'
Generating field #2
? Do you want to add a field to your entity? Yes
? What is the name of your field? weight_units
? What is the type of your field? Enumeration (Java enum type)
? What is the class name of your enumeration? Units
? What are the values of your enumeration (separated by comma)? kg,lb
? Do you want to add validation rules to your field? Yes
? Which validation rules do you want to add? Required
=================Preferences=================
weekly_goal (Integer) required min='10' max='21'
weight_units (Units) required
----

:icons: font
NOTE: After generating the `Weight` and `BloodPressure` entities with a `date` property for their date/time field, I
decided that `timestamp` was a better property name. To fix this, I modified their respective JSON files in the `.jhipster`
directory and ran `yo jhipster:entity` for each entity again. This seemed easier than refactoring with IntelliJ and hoping
it caught all the name instances.

When I ran `./gradlew test`, I received an error about `User` not containing the `preferences` property.

----
Caused by: org.hibernate.AnnotationException: Unknown mappedBy in: org.jhipster.health.domain.Preferences.user,
referenced property unknown: org.jhipster.health.domain.User.preferences
----

I fixed this by removing the reference to `User` in `Preferences`, as well as its `getUser()` and `setUser()` methods.

[source,java]
----
@OneToOne(mappedBy = "preferences")
@JsonIgnore
private User user;
----

I fixed the relationship by adding a mapping on the user-side with a `@OneToOne` mapping in `User.java`:

[source,java]
----
@OneToOne
@JsonIgnore
private Preferences preferences;

public Preferences getPreferences() {
    return preferences;
}

public void setPreferences(Preferences preferences) {
    this.preferences = preferences;
}
----

I then ran `./gradlew liquibaseDiffChangelog` to generate the changelog and added the XML in the generated file to
`*_added_entity_Preferences.xml`.

[source,xml]
----
<!-- Added the preferences field to User -->
<changeSet author="mraible (generated)" id="1439916664921-1">
    <addColumn tableName="JHI_USER">
        <column name="preferences_id" type="int8"/>
    </addColumn>
</changeSet>
<changeSet author="mraible (generated)" id="1439916664921-2">
    <addForeignKeyConstraint baseColumnNames="preferences_id" baseTableName="JHI_USER"
                             constraintName="FK_1r5e40mq4hwtlyd9lemghc8su"
                             deferrable="false" initiallyDeferred="false"
                             referencedColumnNames="id"
                             referencedTableName="PREFERENCES"/>
</changeSet>
----

:icons: font
NOTE: I did have to modify the datasource settings in `liquibase.gradle` again since `git reset` reverted that change.

When I ran `./gradlew test`, I saw some failures, but these were for old tests that I'd already deleted. I
https://github.com/jhipster/generator-jhipster/issues/1886[opened a ticket] with the JHipster project to track this
issue.

I checked in 6 changed files and 78 new files generated by the JHipster before continuing to implement my UI mockups.

=== Application Improvements

To make my new JHipster application into something I could be proud of, I made a number of improvements:

. Fixed issues with entity and variable names.
. Improved HTML layout and i18n messages.
. Added logic so non-admin uses only see their data.
. Implemented UI Mockup as homepage.

NOTE: At this point, I setup continuous testing of this project using https://jenkins-ci.org/[Jenkins]. This is covered
in the <<Deploy It!>> section of this chapter.

==== Fixed issues with entity and variable names.

Shortly after generating all the UI code, I discovered that using plural entity names (e.g. Points and Preferences)
causes you to end up with files, URLs and variable names that end in two 's' characters. For example, the URL to
the points list was `pointss` instead of the more approriate `points`. I fixed this manually in my project and
https://github.com/jhipster/generator-jhipster/issues/1895[created a bug for JHipster on GitHub].

For the `Preferences` entity, I specified `weekly_goals` and `weight_unit` as field names. I was thinking in terms
of database column names when I chose these names. I later learned that these names were used throughout my code. I left
the column names intact and manually renamed everything in Java, JavaScript and HTML to `weeklyGoals` and `weightUnit`.

==== Improved HTML layout and i18n messages

Of all the code I write, writing UI code (HTML, JavaScript, and CSS) is my favorite. I like that you can see changes
immediately and make progress quickly - especially when you're using dual monitors with <<BrowserSync>>. Below is a
consolidated list of changes I made to the HTML to make things look better.

. Improved layout of tables and buttons.
. Improved titles and button labels by editing generated JSON files in `src/main/webapp/i18n/en`.
. Formatted dates using https://docs.angularjs.org/api/ng/filter/date[AngularJS's date filter]. +
  For example: `{{bloodPressure.timestamp | date: 'short'}}`.
. Improved dialogs to hide id when creating a new entity.
. Defaulted to current date on new entries.
. Replaced point metrics with icons on list/detail screens.
. Replaced point metrics with checkboxes on dialog screen.
. Added loading indicator for state transitions.

The biggest visual improvements are on the list screens. I made the buttons a bit smaller, turned button text into tooltips
and moved add/search buttons to the top right corner. For the points list screen, I converted the 1 and 0 metric values
to icons. Before and after screenshots of the points list illustrate the improved, compact layout.

[[img-points-list-before]]
.Default Points List
image::images/chapter2/points-list-before.png[Default Points List, 1319, scaledwidth="100%", align="center"]

[[img-points-list-after]]
.Points List After UI Improvements
image::images/chapter2/points-list-after.png[Points List After UI Improvements, 1319, scaledwidth="100%", align="center"]

I refactored the HTML at the top of `points.html` to put the title, search and add button on the same row. I also removed
the button text in favor of a using https://angular-ui.github.io/bootstrap/#/tooltip[UI Bootstrap's tooltip directive].
The `translate` filter you see in the button titles is provided by https://angular-translate.github.io/[Angular Translate].
Both UI Bootstrap and Angular Translate are included in JHipster by default.

[source,html]
----
<div class="row">
    <div class="col-sm-7">
        <h2 translate="21pointsApp.points.home.title">Points</h2>
    </div>
    <div class="col-sm-5 text-right">
        <form name="searchForm" class="form-inline">
            <div class="form-group p-r">
                <input type="text" id="searchQuery"
                       class="form-control" ng-model="searchQuery"
                       placeholder="{{'entity.action.search' | translate}}">
            </div>
            <button class="btn btn-info btn-sm" ng-click="search()"
                    tooltip="{{'entity.action.search' | translate}}">
                <i class="glyphicon glyphicon-search"></i>
            </button>
            <button class="btn btn-primary btn-sm" ui-sref="points.new"
                    tooltip="{{'entity.action.new' | translate}}">
                <span class="glyphicon glyphicon-plus"></span>
            </button>
        </form>
    </div>
</div>
----

Changing the numbers to icons was pretty easy thanks to Angular's `ng-class` directive.

[source,html]
----
<td class="text-center">
    <i class="glyphicon"
       ng-class="{'glyphicon-ok text-success': points.exercise,
                  'glyphicon-remove text-danger': !points.exercise}"></i>
</td>
<td class="text-center">
    <i class="glyphicon"
       ng-class="{'glyphicon-ok text-success': points.meals,
                  'glyphicon-remove text-danger': !points.meals}"></i>
</td>
<td class="text-center">
    <i class="glyphicon"
       ng-class="{'glyphicon-ok text-success': points.alcohol,
                 'glyphicon-remove text-danger': !points.alcohol}"></i>
</td>
----

Similarly, I changed the input fields to checkboxes in `points-dialog.html`. Angular's `ng-true-value`
and `ng-false-value` made it easy to continue receiving/sending integers to the API.

[source,html]
----
<div class="form-group">
    <div class="checkbox">
        <label>
            <input type="checkbox" ng-model="points.exercise" id="field_exercise"
                   ng-true-value="1" ng-false-value="0">
            <span class="checkbox-material"><span class="check"></span></span>
            <label translate="21pointsApp.points.exercise" for="field_exercise">
                Exercise
            </label>
        </label>
    </div>
</div>
----

After making this change, you can see that the "Add Points" screen is starting to look like the UI mockup
I created.

[[img-add-points-dialog]]
.Add Points Dialog
image::images/chapter2/add-points-dialog.png[Add Points Dialog, 593, scaledwidth="80%", align="center"]

Improving the UI was the most fun, but also the most time consuming as it involved lots of little tweaks to
multiple screens. The next task was more straighforward: implementing business logic.

==== Added logic so non-admin uses only see their data

I wanted to make several improvements to what users could see, based on their roles. A user should be able to see
and modify their data, but nobody else's. I also wanted to ensure that an administrator could see and modify
everyone's data.

===== Hide user selection when not an admin user

The default dialogs for many-to-one relationships allow you to choose the user when you add/edit a record. To make
it so only administrators had this ability, I modified the dialog screens and used the `has-role` directive. This
directive is included with JHipster, in `src/main/webapp/scripts/components/auth/authority.directive.js`. It also has
a `has-any-role` directive that allows you to pass in a comma-delimited list of roles.

[source,html]
----
<div class="form-group" has-role="ROLE_ADMIN">
    <label translate="21pointsApp.weight.user" for="field_user">user</label>
    <select class="form-control" id="field_user" name="user" ng-model="weight.user.id"
            ng-options="user.id as user.login for user in users">
    </select>
</div>
----

Since the dropdown is hidden from non-admins, I had to modify each Resource class to default to the current user when
creating a new record. Below is a diff that shows the changes I needed to make to `PointsResource.java`.

[source,diff]
----
     @Inject
     private PointsSearchRepository pointsSearchRepository;

+    @Inject
+    private UserRepository userRepository;
+
     /**
      * POST  /points -> Create a new points.
      */
     @RequestMapping(value = "/points",
        method = RequestMethod.POST,
        produces = MediaType.APPLICATION_JSON_VALUE)
     @Timed
     public ResponseEntity<Points> create(@Valid @RequestBody Points points) throws URISyntaxException {
         log.debug("REST request to save Points : {}", points);
         if (points.getId() != null) {
             return ResponseEntity.badRequest().header("Failure", "A new points cannot already have an ID").body(null);
         }
+        if (points.getUser() == null || points.getUser().getId() == null) {
+            log.debug("No user passed in, using current user: {}", SecurityUtils.getCurrentLogin());
+            points.setUser(userRepository.findOneByLogin(SecurityUtils.getCurrentLogin()).get());
+        }
         Points result = pointsRepository.save(points);
----

`SecurityUtils` is a class provided by JHipster when you create a project. I had to modify `PointsResourceTest.java` to
be security-aware after making this change.

Spring MVC Test provides a convenient interface called a `RequestPostProcessor` that can be used to modify a request.
Spring Security provides a number of RequestPostProcessor implementations that simplify testing. In order to use
Spring Securityâ€™s RequestPostProcessor implementations, you can include them all with the following static import:

[source,java]
import static org.springframework.security.test.web.servlet.request.SecurityMockMvcRequestPostProcessors.*;

To add Spring Security Test to the 21 Points project, I added `spring-security-test` to my `build.gradle`.

[source,groovy]
----
testCompile group: 'org.springframework.security', name: 'spring-security-test', version: spring_security_version
----

I then proceeded to modify `PointsResourceTest.java`, creating a new `MockMvc` instance that was security aware and
specifying `with(user("user"))` so Spring Security's `SecurityContext` is populated with an authenticated user.

[source,diff]
----
+import org.jhipster.health.repository.UserRepository;
+import org.springframework.beans.factory.annotation.Autowired;
+import org.springframework.web.context.WebApplicationContext;
+import static org.springframework.security.test.web.servlet.request.SecurityMockMvcRequestPostProcessors.user;
+import static org.springframework.security.test.web.servlet.setup.SecurityMockMvcConfigurers.springSecurity;

@@ -63,18 +67,25 @@
     private PointsSearchRepository pointsSearchRepository;

     @Inject
+    private UserRepository userRepository;
+
+    @Inject
     private MappingJackson2HttpMessageConverter jacksonMessageConverter;

     private MockMvc restPointsMockMvc;

     private Points points;

+    @Autowired
+    private WebApplicationContext context;
+
     @PostConstruct
     public void setup() {
         MockitoAnnotations.initMocks(this);
         PointsResource pointsResource = new PointsResource();
         ReflectionTestUtils.setField(pointsResource, "pointsRepository", pointsRepository);
         ReflectionTestUtils.setField(pointsResource, "pointsSearchRepository", pointsSearchRepository);
+        ReflectionTestUtils.setField(pointsResource, "userRepository", userRepository);
         this.restPointsMockMvc = MockMvcBuilders.standaloneSetup(pointsResource).setMessageConverters(jacksonMessageConverter).build();
     }

@@ -93,9 +104,15 @@
     public void createPoints() throws Exception {
         int databaseSizeBeforeCreate = pointsRepository.findAll().size();

-        // Create the Points
+        // create security-aware mockMvc
+        restPointsMockMvc = MockMvcBuilders
+            .webAppContextSetup(context)
+            .apply(springSecurity())
+            .build();

+        // Create the Points
         restPointsMockMvc.perform(post("/api/points")
+                .with(user("user"))
                 .contentType(TestUtil.APPLICATION_JSON_UTF8)
                 .content(TestUtil.convertObjectToJsonBytes(points)))
                 .andExpect(status().isCreated());
----

===== List screen should only show user's data

The next businesses logic improvement I wanted to make was to modify list screens so they'd only show records for current user. For admin
users, they should see all users' data. To facilitate this feature, I modified `PointsResource#getAll` to have a switch based on the user's role.

[source,java]
----
public ResponseEntity<List<Points>> getAll(@RequestParam(value = "page", required = false) Integer offset,
                                           @RequestParam(value = "per_page", required = false) Integer limit)
    throws URISyntaxException {
    Page<Points> page;
    if (SecurityUtils.isUserInRole(AuthoritiesConstants.ADMIN)) {
        page = pointsRepository.findAll(PaginationUtil.generatePageRequest(offset, limit));
    } else {
        page = pointsRepository.findAllForCurrentUser(PaginationUtil.generatePageRequest(offset, limit));
    }
    HttpHeaders headers = PaginationUtil.generatePaginationHttpHeaders(page, "/api/points", offset, limit);
    return new ResponseEntity<>(page.getContent(), headers, HttpStatus.OK);
}
----

The `PointsRepository#findAllForCurrentUser()` method was generated by JHipster and contains a custom query that uses Spring's Expression Language
to grab the user's information from Spring Security.

[source,java]
----
@Query("select points from Points points where points.user.login = ?#{principal.username}")
Page<Points> findAllForCurrentUser(Pageable pageable);
----

[sidebar]
.Ordering By Date
--
Later on, I changed the above query to order by date, so the first records in the list would be the most recent.

[source,java]
----
@Query("select points from Points points where points.user.login = ?#{principal.username} order by points.date desc")
----

In addition, I changed `findAll` to `findAllByOrderByDateDesc` to make the admin user's query order by date. The query for this
is generated dynamically by Spring Data, simply by adding the method to your repository.

[source,java]
----
Page<Points> findAllByOrderByDateDesc(Pageable pageable);
----
--

To make tests pass, I had to update `PointsResourceTest#getAllPoints` to use Spring Security Test's `user` post processor.

[source,diff]
----
 @Test
 @Transactional
 public void getAllPoints() throws Exception {
     // Initialize the database
     pointsRepository.saveAndFlush(points);

-    // Create the Points
+    // create security-aware mockMvc
+    restPointsMockMvc = MockMvcBuilders
+        .webAppContextSetup(context)
+        .apply(springSecurity())
+        .build();

     // Get all the points
-    restPointsMockMvc.perform(get("/api/points"))
+    restPointsMockMvc.perform(get("/api/points")
+            .with(user("admin").roles("ADMIN")))
             .andExpect(status().isOk())
----

==== Implementing the UI Mockup
Making the homepage into something resembling my UI mockup required several steps:

. Adding buttons to facilitate adding new data from the homepage.
. Adding an API to get points achieved in the current week.
. Adding an API to get blood pressure readings in the last 30 days.
. Adding an API to get weigh-ins in the last 30 days.
. Adding charts to display points per week, and blood pressure/weight for last 30 days.

I started by re-using the dialogs that JHipster created for me for entering data. I found that adding new
routes to `main.js` was the easiest way to do this. Instead of routing back to the list screen after a save
succeeded, I routed the user back to the `main` state. I copied the generated `points.new` state from `points.js`
and pasted it into `main.js`.

[source,javascript]
----
.state('points.add', { <1>
    parent: 'home', <2>
    url: 'add/points', <3>
    data: {
        roles: ['ROLE_USER']
    },
    onEnter: ['$stateParams', '$state', '$modal', function($stateParams, $state, $modal) {
        $modal.open({
            templateUrl: 'scripts/app/entities/points/points-dialog.html',
            controller: 'PointsDialogController',
            size: 'lg',
            resolve: {
                entity: function () {
                    return {date: null, exercise: null, meals: null, alcohol: null, notes: null, id: null};
                }
            }
        }).result.then(function(result) { <4>
                $state.go('home', null, { reload: true });
            }, function() {
                $state.go('home');
            })
    }]
})
----
<1> I changed from 'points.new' to 'points.add'.
<2> I changed the parent to be 'home'.
<3> I changed the url from '/new' to 'add/points'.
<4> I changed both result states to be 'home' instead of 'points'.

After configuring the state to add new points from the homepage, I added a button to display the dialog.

[source,html]
----
<div class="col-md-4 text-right">
    <a ui-sref="points.add" class="btn btn-primary btn-raised">Add Points</a>
</div>
----

===== Points This Week

To get points achieved in the current week, I started by adding a unit test to `PointsResourceTest.java` that
would allow me to prove my API was working.

[source,java]
----
private void createPointsByWeek(LocalDate thisMonday, LocalDate lastMonday) {
    User user = userRepository.findOneByLogin("user").get();
    // Create points in two separate weeks
    points = new Points(thisMonday.plusDays(2), 1, 1, 1, user); <1>
    pointsRepository.saveAndFlush(points);

    points = new Points(thisMonday.plusDays(3), 1, 1, 0, user);
    pointsRepository.saveAndFlush(points);

    points = new Points(lastMonday.plusDays(3), 0, 0, 1, user);
    pointsRepository.saveAndFlush(points);

    points = new Points(lastMonday.plusDays(4), 1, 1, 0, user);
    pointsRepository.saveAndFlush(points);
}

@Test
@Transactional
public void getPointsThisWeek() throws Exception {
    LocalDate today = new LocalDate();
    LocalDate thisMonday = today.withDayOfWeek(DateTimeConstants.MONDAY);
    LocalDate lastMonday = thisMonday.minusWeeks(1);
    createPointsByWeek(thisMonday, lastMonday);

    // create security-aware mockMvc
    restPointsMockMvc = MockMvcBuilders
        .webAppContextSetup(context)
        .apply(springSecurity())
        .build();

    // Get all the points
    restPointsMockMvc.perform(get("/api/points")
        .with(user("user").roles("USER")))
        .andExpect(status().isOk())
        .andExpect(content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON))
        .andExpect(jsonPath("$", hasSize(4)));

    // Get the points for this week only
    restPointsMockMvc.perform(get("/api/points-this-week")
        .with(user("user").roles("USER")))
        .andExpect(status().isOk())
        .andExpect(content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON))
        .andExpect(jsonPath("$.week").value(thisMonday.toString()))
        .andExpect(jsonPath("$.points").value(5));
}
----
<1> To simplify testing, I added a new constructor to `Points.java` that contained the arguments I wanted to set. I
    continued this pattern for most tests I created.

Of course, this test failed when I first ran it since "/api/points-this-week" didn't exist in `PointsResource.java`.
You might notice the points-this-week API expects two return values: a date in the `week` field and the total number
of points in the `points` field. I created `PointsPerWeek.java` in my project's `rest.dto` package to hold this
information.

[source,java]
----
public class PointsPerWeek {
    private LocalDate week;
    private Integer points;

    public PointsPerWeek(LocalDate week, Integer points) {
        this.week = week;
        this.points = points;
    }

    public Integer getPoints() {
        return points;
    }

    public void setPoints(Integer points) {
        this.points = points;
    }

    @JsonSerialize(using = CustomLocalDateSerializer.class)
    @JsonDeserialize(using = ISO8601LocalDateDeserializer.class)
    public LocalDate getWeek() {
        return week;
    }

    public void setWeek(LocalDate week) {
        this.week = week;
    }

    @Override
    public String toString() {
        return "PointsThisWeek{" +
            "points=" + points +
            ", week=" + week +
            '}';
    }
}
----

To find all point entries in a particular week, Spring Data JPA made it easy once again. I added a new method
to my `PointsRepository.java` that allowed me to query between two dates.

[source,java]
----
List<Points> findAllByDateBetween(LocalDate firstDate, LocalDate secondDate);
----

From there, it was just a matter of calculating the beginning and end of the current week and processing the data
in `PointsResource.java`.

[source,java]
----
/**
 * GET  /points -> get all the points for the current week.
 */
@RequestMapping(value = "/points-this-week")
@Timed
public ResponseEntity<PointsPerWeek> getPointsThisWeek() {
    // Get current date
    LocalDate now = new LocalDate(); <1>
    // Get first day of week
    LocalDate startOfWeek = now.withDayOfWeek(DateTimeConstants.MONDAY); <2>
    // Get last day of week
    LocalDate endOfWeek = now.withDayOfWeek(DateTimeConstants.SUNDAY);
    log.debug("Looking for points between: {} and {}", startOfWeek, endOfWeek);

    List<Points> points = pointsRepository.findAllByDateBetween(startOfWeek, endOfWeek);
    // filter by current user and sum the points
    Integer numPoints = points.stream()
        .filter(p -> p.getUser().getLogin().equals(SecurityUtils.getCurrentLogin()))
        .mapToInt(p -> p.getExercise() + p.getMeals() + p.getAlcohol())
        .sum();

    PointsPerWeek count = new PointsPerWeek(startOfWeek, numPoints);
    return new ResponseEntity<>(count, HttpStatus.OK);
}
----
<1> I later discovered that creating a new `LocalDate` uses the server's timezone by default. When I deployed on a server
    using UTC, I discovered this logic didn't work too well. I decided I'd make it a user preference or look into using a
    JavaScript library like http://pellepim.bitbucket.org/jstz/[jsTimezoneDetect] to detect client timezone and pass it
    to the server.
<2> Since I live in the United States, I'm used to the week beginning on Sunday. However, since Joda Time uses Monday
    as the first day of the week, I decided this would be my application's logic as well.

To support this new method on the client, I added a new method to my `Points` service.

[source,javascript]
.src/main/webapp/scripts/components/entities/points/points.service.js
----
.factory('Points', function ($resource, DateUtils) {
    return $resource('api/points/:id', {}, {
        'query': { method: 'GET', isArray: true},
        'thisWeek': { method: 'GET', isArray: false, url: 'api/points-this-week'},
        ...
    });
});
----

Then I added the service to `main.controller.js` and calculated the data I wanted to display.

[source,javascript]
.src/main/webapp/scripts/app/main/main.controller.js
----
.controller('MainController', function ($scope, Principal, Points) {
    Principal.identity().then(function(account) {
        $scope.account = account;
        $scope.isAuthenticated = Principal.isAuthenticated;
    });

    Points.thisWeek(function(data) {
        $scope.pointsThisWeek = data;
        $scope.pointsPercentage = (data.points / 21) * 100;
    });
});
----

I added a Bootstrap progress bar to `main.html` to show points-this-week progress.

[source,html]
----
<div class="row">
    <div class="col-md-10">
        <div class="progress progress-lg" ng-show="pointsThisWeek.points"> <1>
            <div class="progress-bar progress-bar-success progress-bar-striped" role="progressbar"
                 aria-valuenow="{{pointsThisWeek.points}}"
                 aria-valuemin="0" aria-valuemax="21" style="width: {{pointsPercentage}}%">
                 {{pointsThisWeek.points}} / Goal: 10
            </div>
        </div>
        <alert type="info" ng-hide="pointsThisWeek.points">
            No points yet this week, better get moving!
        </alert>
    </div>
</div>
----
<1> I later realized this could be replaced with UI Bootstrap's
    https://angular-ui.github.io/bootstrap/#/progressbar[progressbar], but why fix something if it isn't broke?! ;)

Below is a screenshot of what this progress bar looked like after entering some data for the current user.

[[img-homepage-progress-bar]]
.Points this week progress bar
image::images/chapter2/homepage-points-this-week.png[Points this week progress bar, 1381, scaledwidth="100%", align="center"]

You might notice the Goal is hardcoded to "10" in the progress bar's HTML. To fix this, I needed to add the ability
to fetch the user's preferences. I created a new method in `PreferencesResource.java` to return the user's preferences
(or a default weekly goal of 10 points if no preferences are defined).

[source,java]
----
/**
 * GET  /my-preferences -> get the current user's preferences.
 */
@RequestMapping(value = "/my-preferences")
@Timed
public ResponseEntity<Preferences> getUserPreferences() {
    String username = SecurityUtils.getCurrentLogin();
    log.debug("REST request to get Preferences : {}", username);
    User user = userRepository.findOneByLogin(username).get();

    if (user.getPreferences() != null) {
        return new ResponseEntity<>(user.getPreferences(), HttpStatus.OK);
    } else {
        Preferences defaultPreferences = new Preferences();
        defaultPreferences.setWeeklyGoal(10); // default
        return new ResponseEntity<>(defaultPreferences, HttpStatus.OK);
    }
}
----

To facilitate calling this endpoint, I added a new `user` method to the `Preferences` client service.

[source,javascript]
.src/main/webapp/scripts/components/entities/preferences/preferences.service.js
----
.factory('Preferences', function ($resource) {
    return $resource('api/preferences/:id', {}, {
        'query': { method: 'GET', isArray: true},
        'user': { method: 'GET', isArray: false, url: '/api/my-preferences'},
        ...
    });
});
----

In `main.controller.js`, I added the `Preferences` service as a dependency and set the preferences on `$scope`
so the HTML template could read it.

[source,javascript]
----
.controller('MainController', function ($scope, Principal, Points, Preferences) {
    ...

    Preferences.user(function(data) {
        $scope.preferences = data;
    })
});
----

Now that a user's preferences were available, I modified `main.html` to display the user's weekly goal, as well
as to color the progress bar appropriately with `ng-class`.

[source,html]
----
<div class="progress-bar progress-bar-striped" role="progressbar"
     ng-class="{'progress-bar-success': pointsThisWeek.points >= preferences.weeklyGoal,
                'progress-bar-danger': pointsThisWeek.points < 10,
                'progress-bar-warning': pointsThisWeek.points > 10 && pointsThisWeek.points < preferences.weeklyGoal}"
     aria-valuenow="{{pointsThisWeek.points}}"
     aria-valuemin="0" aria-valuemax="21" style="width: {{pointsPercentage}}%">
    <span ng-show="pointsThisWeek.points">
        {{pointsThisWeek.points}} / Goal: {{preferences.weeklyGoal}}
    </span>
    <span class="sr-only">{{pointsPercentage}} points this week</span>
</div>
----

To finish things off for user preferences, I added a link to edit them and an appropriate state to allow it in `main.js`.

===== Blood Pressure and Weight for Last 30 Days

To populate the remaining two charts on the homepage, I needed to fetch the user's blood pressure readings and weigh-ins
for the last 30 days. I added a method to `BloodPressureResourceTest.java` to setup my expectations.

[source,java]
----
private void createBloodPressureByMonth(DateTime firstOfMonth, DateTime firstDayOfLastMonth) {
    User user = userRepository.findOneByLogin("user").get();
    // this month
    bloodPressure = new BloodPressure(firstOfMonth, 120, 80, user);
    bloodPressureRepository.saveAndFlush(bloodPressure);
    bloodPressure = new BloodPressure(firstOfMonth.plusDays(10), 125, 75, user);
    bloodPressureRepository.saveAndFlush(bloodPressure);
    bloodPressure = new BloodPressure(firstOfMonth.plusDays(20), 100, 69, user);
    bloodPressureRepository.saveAndFlush(bloodPressure);

    // last month
    bloodPressure = new BloodPressure(firstDayOfLastMonth, 130, 90, user);
    bloodPressureRepository.saveAndFlush(bloodPressure);
    bloodPressure = new BloodPressure(firstDayOfLastMonth.plusDays(11), 135, 85, user);
    bloodPressureRepository.saveAndFlush(bloodPressure);
    bloodPressure = new BloodPressure(firstDayOfLastMonth.plusDays(23), 130, 75, user);
    bloodPressureRepository.saveAndFlush(bloodPressure);
}

@Test
@Transactional
public void getBloodPressureForLast30Days() throws Exception {
    DateTime now = new DateTime();
    DateTime firstOfMonth = now.withDayOfMonth(1);
    DateTime firstDayOfLastMonth = firstOfMonth.minusMonths(1);
    createBloodPressureByMonth(firstOfMonth, firstDayOfLastMonth);

    // create security-aware mockMvc
    restBloodPressureMockMvc = MockMvcBuilders
        .webAppContextSetup(context)
        .apply(springSecurity())
        .build();

    // Get all the blood pressure readings
    restBloodPressureMockMvc.perform(get("/api/bloodPressures")
        .with(user("user").roles("USER")))
        .andExpect(status().isOk())
        .andExpect(content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON))
        .andExpect(jsonPath("$", hasSize(6)));

    // Get the blood pressure readings for the last 30 days
    restBloodPressureMockMvc.perform(get("/api/bp-by-days/{days}", 30)
        .with(user("user").roles("USER")))
        .andDo(print())
        .andExpect(status().isOk())
        .andExpect(content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON))
        .andExpect(jsonPath("$.period").value("Last 30 Days"))
        .andExpect(jsonPath("$.readings.[*].systolic").value(hasItem(120)))
        .andExpect(jsonPath("$.readings.[*].diastolic").value(hasItem(69)));
}
----

I created a `BloodPressureByPeriod.java` class to return the results from the API.

[source,java]
.BloodPressureByPeriod.java
----
public class BloodPressureByPeriod {
    private String period;
    private List<BloodPressure> readings;

    public BloodPressureByPeriod(String period, List<BloodPressure> readings) {
        this.period = period;
        this.readings = readings;
    }
    ...
}
----

Using similar logic that I used for points-this-week, I created a new method in `BloodPressureRepository.java` that
allowed me to query between two different dates. I also added orderBy logic so the records would be sorted by date
entered.

[source,java]
----
List<BloodPressure> findAllByTimestampBetweenOrderByTimestampDesc(DateTime firstDate, DateTime secondDate);
----

Next, I created a new method in `BloodPressureResource.java` that calculated the first and last days of the current
month, executed the query, filtered by the current user and constructed the data to return.

[source,java]
----
/**
 * GET  /bp-by-days -> get all the blood pressure readings by last x days.
 */
@RequestMapping(value = "/bp-by-days/{days}")
@Timed
public ResponseEntity<BloodPressureByPeriod> getByDays(@PathVariable int days) {
    LocalDate today = new LocalDate();
    LocalDate previousDate = today.minusDays(days);
    DateTime daysAgo = previousDate.toDateTimeAtCurrentTime();
    DateTime rightNow = today.toDateTimeAtCurrentTime();

    List<BloodPressure> readings = bloodPressureRepository.findAllByTimestampBetweenOrderByTimestampDesc(daysAgo, rightNow);
    BloodPressureByPeriod response = new BloodPressureByPeriod("Last " + days + " Days", filterByUser(readings));
    return new ResponseEntity<>(response, HttpStatus.OK);
}

private List<BloodPressure> filterByUser(List<BloodPressure> readings) {
    Stream<BloodPressure> userReadings = readings.stream()
        .filter(bp -> bp.getUser().getLogin().equals(SecurityUtils.getCurrentLogin()));
    return userReadings.collect(Collectors.toList());
}
----

I added a new method to support this API in `bloodPressure.service.js`.

[source,javascript]
----
.factory('BloodPressure', function ($resource, DateUtils) {
    return $resource('api/bloodPressures/:id', {}, {
        'query': { method: 'GET', isArray: true},
        'last30Days': { method: 'GET', isArray: false, url: 'api/bp-by-days/30'},
        ...
    });
});
----

While gathering this data seemed easy enough, the hard part was figuring out what charting library to use to display it.

===== Last 30 Days Charts

I did a https://twitter.com/mraible/status/633738800879898624[bit of research] and decided to use
http://krispo.github.io/angular-nvd3[Angular-nvD3]. I'd heard good things about http://d3js.org/[D3.js] and Angular-nvD3
is built on top of it. To install Angular-nvD3, I used Bower's install command.

----
bower install angular-nvd3 --save
----

Then I ran `grunt wiredep` to update `index.html` and `karma.conf.js` with references to the new files. I also updated
`app.js` to add `nvd3` as a dependency.

[source,javascript]
----
angular.module('21pointsApp', ['LocalStorageModule', 'tmh.dynamicLocale', 'pascalprecht.translate',
    'ui.bootstrap', // for modal dialogs
    'ngResource', 'ui.router', 'ngCookies', 'ngCacheBuster', 'ngFileUpload', 'infinite-scroll', 'nvd3'])
----

I modified `main.controller.js` to have the `BloodPressure` service as a dependency and went to work building the
data so Angular-nvD3 could render it. I found that charts required a bit of JSON to configure them, so I created
a service to contain this configuration.

[source,javascript]
.src/main/webapp/scripts/component/chart/chart.service.js
----
'use strict';

angular.module('21pointsApp').factory('Chart', function Chart() {
    return {
        getBpChartConfig: function() {
            return bpChartConfig;
        }
    }
});

var today = new Date();
var priorDate = new Date().setDate(today.getDate()-30);

var bpChartConfig = {
    chart: {
        type: "lineChart",
        height: 200,
        margin: {
            top: 20,
            right: 20,
            bottom: 40,
            left: 55
        },
        x: function(d){ return d.x; },
        y: function(d){ return d.y; },
        useInteractiveGuideline: true,
        dispatch: {},
        xAxis: {
            axisLabel: "Dates",
            showMaxMin: false,
            tickFormat: function(d){
                return d3.time.format("%b %d")(new Date(d));
            }
        },
        xDomain: [priorDate, today],
        yAxis: {
            axisLabel: "",
            axisLabelDistance: 30
        },
        transitionDuration: 250
    },
    title: {
        enable: true
    }
};
----

In `main.controller.js`, I grabbed the blood pressure readings from the API and morphed them into data that Angular-nvD3
could understand.

[source,javascript]
----
BloodPressure.last30Days(function(bpReadings) {
    $scope.bpReadings = bpReadings;
    if (bpReadings.readings.length) {
        $scope.bpOptions = angular.copy(Chart.getBpChartConfig());
        $scope.bpOptions.title.text = bpReadings.period;
        $scope.bpOptions.chart.yAxis.axisLabel = "Blood Pressure";
        var systolics, diastolics;
        systolics = [];
        diastolics = [];
        bpReadings.readings.forEach(function (item) {
            systolics.push({
                x: new Date(item.timestamp),
                y: item.systolic
            });
            diastolics.push({
                x: new Date(item.timestamp),
                y: item.diastolic
            });
        });
        $scope.bpData = [{
            values: systolics,
            key: 'Systolic',
            color: '#673ab7'
        }, {
            values: diastolics,
            key: 'Diastolic',
            color: '#03a9f4'
        }];
    }
});
----

Finally, I used the _nvd3_ directive in `main.html` to read `$scope.bpOptions` and `$scope.bpData` and display a chart.

[source,html]
----
<div class="row">
    <div class="col-md-10">
        <span ng-if="bpReadings.readings.length">
            <nvd3 options="bpOptions" data="bpData" class="with-3d-shadow with-transitions"></nvd3>
        </span>
        <span ng-if="!bpReadings.readings.length">
            <alert type="info">No blood pressure readings found.</alert>
        </span>
    </div>
</div>
----

After entering some test data, I was quite pleased with the results.

[[img-homepage-bp-last-30-days]]
.Blood Pressure Last 30 Days Chart
image::images/chapter2/homepage-bp-last-30-days.png[Blood Pressure Last 30 Days Chart, 1338, scaledwidth="100%", align="center"]

I made similar changes to get weigh-ins for the last 30 days and display them as a chart.

==== Lines of Code

After finishing the MVP (Minimum Viable Product) of 21 Point Health, I did some quick calculations to see how
many lines of code were produced by JHipster. You can see from the graph below that I only had to write 1,152
lines of code, JHipster did the rest for me. In other words, I was able to generate 91.7% of the code in my project!

[[img-21-points-loc]]
.Project Lines of Code
image::images/chapter2/21-points-loc.png[Project Lines of Code, 700, scaledwidth="100%", align="center"]

To drill down further, I made a graph of the top three languages in the project: Java, JavaScript and HTML.

[[img-21-points-loc-by-language]]
.Project Lines of Code by Language
image::images/chapter2/21-points-loc-by-language.png[Project Lines of Code by Language, 900, scaledwidth="100%", align="center"]

Amount of each code I had to write in each language:

* Java: 582 lines
* JavaScript: 268
* HTML: 109

Wahoo! Thanks JHipster!

.Testing
****
You probably noticed that a lot of the Java code I wrote was in the tests. I felt these tests were essential to prove
the business logic I implemented was correct. It's never easy to work with dates, but Joda Time greatly simplified
it and Spring Data JPA made it easy to write _between date_ queries.

I believe TDD (Test-Driven Development) is a great way to write code. However, when developing UIs, I tend to make them
work before writing tests. It's usually a very visual activity and with the aid of BrowserSync, there's rarely a delay in
seeing your changes. I do like to write unit tests for my Angular controllers and directives using
http://jasmine.github.io/2.3/introduction.html[Jasmine]. I also like to write integration tests with
https://angular.github.io/protractor/#/[Protractor].

I did not write any JavaScript tests for this project because I was in a time crunch and I was able to visually verify
things worked as I wanted. I do plan to write unit and integration tests when I find the time, but didn't think they
were necessary for the MVP.
****

=== Deploy It!

*[red]#Question: I think "Deploy It!" is a good title if this section changes to active vs. passive voice. However,
if I keep things as passive, "Deployment to Heroku" or "Cloud Deployment" is probably better.#*

JHipster ships with support for deploying to Cloud Foundry, Heroku, Openshift and AWS. I chose to use Heroku to
deploy my application to the cloud because I'd worked with it before. When you prepare a JHipster application for
production, it's recommended you use the pre-configured "production" profile. With Gradle, you can package your
application by specify this profile when building.

----
gradlew -Pprod bootRepackage
----

The command looks similar when using Maven.

----
mvn -Pprod package
----

When built with the production profile, an optimized JavaScript client is built. You can invoke this using Grunt or
Gulp by running `grunt build` or `gulp build`, depending on which tool your project uses. The production profile also
configures gzip compression with a servlet filter, cache headers and monitoring via Metrics[https://github.com/dropwizard/metrics].
If you have a http://graphite.wikidot.com/[Graphite] server configured in your `application-prod.yaml` file, your application
will automatically send metrics data to it.

To setup 21 Point Health on Heroku, I started by logging in. I already had the https://toolbelt.heroku.com/[Heroku Toolbelt]
installed and a Heroku account created.

NOTE: I first deployed to Heroku after integrating the Material Design theme. This means that no entities were created
and it was basically a default JHipster application.

----
[mraible:~/dev/21-points] $ heroku login
Enter your Heroku credentials.
Email: matt@raibledesigns.com
Password (typing will be hidden):
Authentication successful.
----

Next, I ran `yo jhipster:heroku` as recommended in the http://jhipster.github.io/heroku.html[Deploying to Heroku
documentation]. I tried using the name "21points" for my application when prompted.

----
âŒ23% [mraible:~/dev/21-points] 18s $ yo jhipster:heroku
Heroku configuration is starting
? Name to deploy as: 21points
? On which region do you want to deploy ? us

Using existing Git repository

Installing Heroku CLI deployment plugin
Installing https://github.com/heroku/heroku-deploy...
done

Creating Heroku application and setting up node environment
heroku create 21points --addons heroku-postgresql:hobby-dev
âœ– { [Error: Command failed: /bin/sh -c heroku create 21points --addons heroku-postgresql:hobby-dev
 !    Name must start with a letter and can only contain lowercase letters, numbers, and dashes.
]
  killed: false,
  code: 1,
  signal: null,
  cmd: '/bin/sh -c heroku create 21points --addons heroku-postgresql:hobby-dev' }
----

You can see my first attempt failed for the same reason that creating a local PostgreSQL database failed. It didn't
like that the database name started with numbers. I tried again with "health", but that failed too since a Heroku app
with this name already existed. Finally, I settled on using "health-by-points" as the application name and everything
succeeded.

----
$ yo jhipster:heroku
Heroku configuration is starting
? Name to deploy as: health-by-points
? On which region do you want to deploy ? us

Using existing Git repository

Installing Heroku CLI deployment plugin
Installing https://github.com/heroku/heroku-deploy...
done

Creating Heroku application and setting up node environment
heroku create health-by-points --addons heroku-postgresql:hobby-dev
Creating health-by-points... done, stack is cedar-14

Adding heroku-postgresql:hobby-dev to health-by-points...
done

https://health-by-points.herokuapp.com/ | https://git.heroku.com/health-by-points.git

Git remote heroku added

Creating Heroku deployment files

Building application
:generateMainMapperClasses

Download https://oss.sonatype.org/content/repositories/releases/io/dropwizard/metrics/metrics-healthchecks/3.1.2/metrics-healthchecks-3.1.2.pom
...

BUILD SUCCESSFUL

Total time: 2 mins 58.204 secs

Uploading your application code.
 This may take several minutes depending on your connection speed...
Uploading build/libs/21points-0.1-SNAPSHOT.war....
----

I was pumped to see that this process worked and my application was available at http://healthy-by-points.herokuapp.com.
I quickly changed the default passwords for *admin* and *user* to make things more secure.

[[img-deployed-to-heroku]]
.First Deployment to Heroku
image::images/chapter2/deployed-to-Heroku.png[First Deployment to Heroku, 1144, scaledwidth="100%", align="center"]

Next, I bought the _21-points.com_ from https://domains.google.com[Google Domains]. To configure this domain for
Heroku, I ran `heroku domains:add`.

----
$ heroku domains:add www.21-points.com
Adding www.21-points.com to health-by-points... done
!    Configure your app's DNS provider to point to the DNS Target www.21-points.com
!    For help, see https://devcenter.heroku.com/articles/custom-domains
----

I read the https://devcenter.heroku.com/articles/custom-domains[documentation], then went to work configuring
DNS settings on Google Domains. I configured a Subdomain forward:

----
21-points.com â†’ http://www.21-points.com
----

I also configured a custom resource record with a CNAME to point to health-by-points.herokuapp.com.

.Custom resource record on Google Domains
|===
|Name |Type |TTL |Data

|*
|CNAME
|1h
|health-by-points.herokuapp.com
|===

This was all I needed to get my JHipster application running on Heroku. However, after generating entities and adding
more code to the project, I found some issues. First of all, I learned that after the initial setup, you can redeploy
your application using https://github.com/heroku/heroku-deploy[heroku-deploy]. Use the following command to install
this plugin:

----
heroku plugins:install https://github.com/heroku/heroku-deploy
----

Then you package your JHipster project for production and deploy it. Using Gradle, this looks as follows:

----
gradlew -Pprod bootRepackage -x test
heroku deploy:jar --jar build/libs/*war --app health-by-points
----

With Maven, the commands look slightly different:
----
mvn install -Pprod -DskipTests
heroku deploy:jar --jar target/*.war
----

I ran the deployment command after generating all my entities and it looked like everything worked just fine.

....
$ heroku deploy:jar --jar build/libs/*war --app health-by-points
Uploading build/libs/21points-0.1-SNAPSHOT.war....
-----> Packaging application...
       - app: health-by-points
       - including: build/libs/21points-0.1-SNAPSHOT.war
-----> Creating build...
       - file: slug.tgz
       - size: 63MB
-----> Uploading build...
       - success
-----> Deploying...
remote:
remote: -----> Fetching custom tar buildpack... done
remote: -----> JVM Common app detected
remote: -----> Installing OpenJDK 1.8... done
remote: -----> Discovering process types
remote:        Procfile declares types -> web
remote:
remote: -----> Compressing... done, 112.5MB
remote: -----> Launching... done, v14
remote:        https://health-by-points.herokuapp.com/ deployed to Heroku
remote:
-----> Done
....

I tailed my log files with `heroku logs --tail` to make sure everything started up OK. I was soon disappointed when
the application didn't startup in 60 seconds.

----
Error R10 (Boot timeout) -> Web process failed to bind to $PORT within 60 seconds of launch
----

This is an expected problem with JHipster and Heroku. I created a support ticket at https://help.heroku.com/ and asked
for my application's timeout to be increased to 120 seconds. Heroku's Support team was quick to respond and my timeout
was increased within minutes.

TIP: If you need to reset your Postgres database on Heroku, you can do so my logging into http://api.heroku.com. Then
click on your application name > Add-Ons > Heroku Postgres :: Gray and select _Reset Database_ from the gear icon
in the top right corner.

==== ElasticSearch on Heroku

Once my application's timeout was increased, it seemed like everything was working. I tried to register a new user,
and saw the following error message in my logs.

*[red]#Question: Should I keep the timestamp in the error below, or remove it?#*

----
2015-08-20T14:37:54.660329+00:00 app[web.1]: Caused by: org.elasticsearch.client.transport.NoNodeAvailableException:
None of the configured nodes are available: []
----

I searched for an Elasticsearch add-on for Heroku and found https://devcenter.heroku.com/articles/bonsai[Bonsai
Elasticsearch]. It's cheapest plan was $10/month. Since I didn't want to pay for anything right away, I decided
to configure Elasticsearch to use an in-memory store like it did in development.footnote[I later discovered that
https://addons.heroku.com/searchbox[Searchbox Elasticsearch] offers a free plan]. I updated my `application-prod.yml`
file to use Heroku's ephemeral filesystem.

[source,yaml]
---
# Configure prod to use ElasticSearch in-memory.
# http://stackoverflow.com/questions/12416738/how-to-use-herokus-ephemeral-filesystem
data:
    elasticsearch:
        cluster-name:
        cluster-nodes:
        properties:
            path:
              logs: /tmp/elasticsearch/log
              data: /tmp/elasticsearch/data
----

==== Mail on Heroku

After making this change, I repacked and redeployed. This time, when I tried to register, I recieved an error when my
`MailService` tried to send me an activation email.

----
2015-08-20T15:11:36.809174+00:00 heroku[web.1]: Process running mem=561M(109.6%)
2015-08-20T15:11:36.809174+00:00 heroku[web.1]: Error R14 (Memory quota exceeded)
2015-08-20T15:11:41.395945+00:00 heroku[router]: at=info method=POST path="/api/register?cacheBuster=1440083497301" host=www.21-points.com ...
2015-08-20T15:11:43.106106+00:00 app[web.1]: [WARN] org.jhipster.health.service.MailService - E-mail could not be sent to
user 'matt@raibledesigns.com', exception is: Mail server connection failed; nested exception is javax.mail.MessagingException:
Connection error (java.net.ConnectException: Connection refused). Failed messages: javax.mail.MessagingException:
Connection error (java.net.ConnectException: Connection refused)
----

NOTE: You might notice the "Memory quota exceeded" message in the logs. I receive this often when running JHipster applications
under Heroku's https://www.heroku.com/pricing[free and hobby dynos]. My application stays running though, so I've learned
to ignore it.

I'd used Heroku's https://addons.heroku.com/sendgrid[SendGrid Add-On] in the past, so I installed added it to my project.

----
$ heroku addons:create sendgrid
Creating giving-softly-5465... done, (free)
Adding giving-softly-5465 to health-by-points... done
Setting SENDGRID_PASSWORD, SENDGRID_USERNAME and restarting health-by-points... done, v17
Use `heroku addons:docs sendgrid` to view documentation.
----

Then I updated `application-prod.yml` to use the configured `SENDGRID_PASSWORD` and `SENDGRID_USERNAME` environment
variables for mail, as well as to turn authentication on.

----
mail:
    host: smtp.sendgrid.net
    port: 587
    username: ${SENDGRID_USERNAME}
    password: ${SENDGRID_PASSWORD}
    protocol: smtp
    tls: false
    auth: true
    from: app@21-points.com
----

After repackaging and redeploying, I used the built-in Health checks feature of my application to verify that everything
was configured correctly.

=== Monitoring and Analytics

JHipster generates the code necessary for Google Analytics in every application's `src/main/webapp/index.html` file.
I chose not to enable this just yet, but I hope to eventually. I already have a http://www.google.com/analytics/
[Google Analytics] account, so it's just a matter of creating a new account for www.21-points.com, copying the
account number and modifying the following section of `index.html`:

[source,html]
----
<!-- Google Analytics: uncomment and change UA-XXXXX-X to be your site's ID.
<script>
    (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
    function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
    e=o.createElement(i);r=o.getElementsByTagName(i)[0];
    e.src='//www.google-analytics.com/analytics.js';
    r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
    ga('create','UA-XXXXX-X');ga('send','pageview');
</script>-->
----

I've used http://newrelic.com/[New Relic] to monitor my production applications in the past. There is a free
https://addons.heroku.com/newrelic[New Relic Add-On] for Heroku. Heroku's https://devcenter.heroku.com/articles/newrelic
[New Relic APM] describes how to set things up if you're letting Heroku do the build for you (meaning, you deploy with
`git push heroku master`). However, if you're using the heroku-deploy plugin, it's a bit different.

You'll first need to download the New Relic Agent JAR manually and put it in a location relative to the root directory
of your project. Then you can run a command like:

----
heroku deploy:jar --jar build/libs/*war --includes newrelic-agent.jar
----

That will include the JAR in the slug. Then you'll need to modify your Procfile to include the option:

----
-javaagent:newrelic-agent.jar
----

=== Continuous Integration and Deployment

After generating entities for this project, I wanted to configure a continuous integration (CI) server to build/test/deploy
whenever I checked in changes to Git. I chose https://jenkins-ci.org/[Jenkins] for my CI server and used the simplest
configuration possible: I downloaded `jenkins.war` to `/opt/tools/jenkins` on my MacBook Pro. I started it using
the following command.

----
java -jar jenkins.war --httpPort=9000
----

JHipster has good documentation on http://jhipster.github.io/setting_up_ci.html[setting up continuous integration] and
http://jhipster.github.io/heroku.html[deploying to Heroku]. Their continuous integration documentation also shows
how to setup Jenkins on http://jhipster.github.io/setting_up_ci_linux.html[Linux] and
http://jhipster.github.io/setting_up_ci_windows.html[Windows]. However, it doesn't have any documentation on how
to configure a job to build, test and deploy. This section aims to fix that.

I added `jasmine-reporters` and `karma-junit-reporter` to my project so I could read JavaScript test results with Jenkins.

----
npm install jasmine-reporters --save-dev
npm install karma-junit-reporter --save-dev
----

Then I updated `src/test/javascript/karma.conf.js` to override the default plugins, specify reporters and configure
the JUnit Reporter.

[source,javascript]
----
singleRun: false,

plugins: [
    'karma-chrome-launcher',
    'karma-phantomjs-launcher',
    'karma-jasmine',
    'karma-junit-reporter'
],

reporters: ['dots', 'junit'],

junitReporter: {
    outputFile: '../build/test-results/TEST-javascript-results.xml',
    suite: 'unit'
}
----

[TIP]
====
I created a new Karma configuration in `Gruntfile.js` to allow continuous testing while you're _in the zone_. When running
`grunt karma:zone`, tests will automatically be re-executed when you save changes.

[source,javascript]
----
karma: {
    unit: {
        configFile: 'src/test/javascript/karma.conf.js',
        singleRun: true
    },
    zone: {
        configFile: 'src/test/javascript/karma.conf.js',
        singleRun: false,
        autoWatch: true
    }
}
----

To make this work, I also had to update the 'test' task to run `karma:unit` instead of `karma`.
====

I setup a new Freestyle project in Jenkins. Below is the configuration I used.

* Project name: `21-points`
* Source Code Management
** Git Repository: `git@bitbucket.org:mraible/21-points.git`
** Branches to build: `*/master`
** Additional Behaviours: `Wipe out repository & force clone`
* Build Triggers
** Poll SCM / Schedule: `H/5 * * * *`
* Build
** Invoke Gradle script / Use Gradle Wrapper / Tasks: `-Pprod clean test bootRepackage`
* Post-build Actions
** Build other projects: `21-points-deploy`
** Publish JUnit test result report / Test Report XMLs: `build/test-results/*.xml`

I then created another job to deploy to Heroku.

* Project name: `21-points-deploy`
* Source Code Management
** Git Repository: `git@bitbucket.org:mraible/21-points.git`
** Branches to build: `*/master`
* Build
** Invoke Gradle script / Use Gradle Wrapper / Tasks: `-Pprod bootRepackage -x test`
** Execute Shell / Command: `heroku deploy:jar --jar build/libs/*.war --app health-by-points`

When working on this project, I'd start Jenkins and have it running while I checked code in. I did not install it on a
server and leave it running continuously. My reason was simple: I was only coding in bursts and didn't need to waste
computing cycles or want to pay for a cloud instance to run it.

=== Summary

This section showed you how I created a health tracking web application with JHipster. It walked you through upgrading to the
latest release of JHipster and how to perform code-generation with `yo jhipster:entity`. It showed you how to you can
modify relationships between entities after-the-fact and use Liquibase to generate changelogs to update your database.
You learned how to do test-first development when writing new APIs and how Spring Data JPA makes it easy to add custom
queries. You also saw how to re-use existing dialogs on different pages, add new methods to client services and how to
manipulate data to display pretty charts.

After modifying the application to look like the UI mockups I created, you saw how to deploy to Heroku and some
common issues I encountered along the way. Finally, you learned how to use Jenkins to build, test and deploy a
Gradle-based JHipster project. I highly recommend doing something similar shortly after you've created your project
and verified all tests pass.

In the next chapter, I'll explain JHipster's UI components in more details. AngularJS, Bootstrap, JavaScript build tools,
Sass, WebSockets and BrowserSync. These are all technologies packed in a JHipster application, so it's useful to dive
in and learn a bit more about them.



